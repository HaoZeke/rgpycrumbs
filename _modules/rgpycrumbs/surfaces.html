<!DOCTYPE html>
<html lang="en" data-accent-color="violet" data-content_root="../../">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"><title>rgpycrumbs.surfaces - rgpycrumbs documentation</title><link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" />
      <link rel="canonical" href="rgpycrumbs.rgoswami.me/_modules/rgpycrumbs/surfaces.html" /><script>
    function setColorMode(t){let e=document.documentElement;e.setAttribute("data-color-mode",t);let a=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,s=t;"auto"===t&&(s=a?"dark":"light"),"light"===s?(e.classList.remove("dark"),e.classList.add("light")):(e.classList.remove("light"),e.classList.add("dark"))}
    setColorMode(localStorage._theme||"auto");
  </script><link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=e1a1ceaf" />
    <link rel="stylesheet" type="text/css" href="../../_static/shibuya.css?v=a318c5d4" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=4ae1632d" />
    <link rel="stylesheet" type="text/css" href="../../_static/autodoc_pydantic.css" />
    <link media="print" rel="stylesheet" type="text/css" href="../../_static/print.css?v=20ff2c19" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --sy-f-text: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
  --sy-f-heading: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
}
</style>
    <meta property="og:type" content="website"/>
  <meta property="og:url" content="rgpycrumbs.rgoswami.me/_modules/rgpycrumbs/surfaces.html"/>
  <meta property="og:title" content="rgpycrumbs.surfaces"/>
    <meta name="twitter:card" content="summary"/>
  <!-- Manual favicon handling with favicon.io -->
<!-- since sphinx-favicon doesn't work with shibuya -->
<link rel="icon" type="image/png" sizes="16x16" href="../../_static/favicons/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../_static/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="192x192" href="../../_static/favicons/android-chrome-192x192.png">
<link rel="icon" type="image/png" sizes="512x512" href="../../_static/favicons/android-chrome-512x512.png">
<link rel="apple-touch-icon" sizes="180x180" href="../../_static/favicons/apple-touch-icon.png">
<link rel="shortcut icon" href="../../_static/favicons/favicon.ico">
<link rel="manifest" href="../../_static/favicons/site.webmanifest">
<!-- Plausible injection -->
<script
  defer
  data-domain="rgpycrumbs.rgoswami.me"
  src="https://analytics.turtletech.us/js/script.hash.outbound-links.js"
></script>
<script>
  window.plausible =
    window.plausible ||
    function () {
      (window.plausible.q = window.plausible.q || []).push(arguments);
    };
</script></head>
<body><div class="sy-head">
  <div class="sy-head-blur"></div>
  <div class="sy-head-inner sy-container mx-auto">
    <a class="sy-head-brand" href="../../index.html">
      <img class="light-logo" src="../../_static/pycrumbs_notext.svg" alt="rgpycrumbs" height="28" loading="lazy" />
      <img class="dark-logo" src="../../_static/pycrumbs_notext.svg" alt="rgpycrumbs" height="28" loading="lazy" />
      <strong>rgpycrumbs</strong>
    </a>
    <div class="sy-head-nav" id="head-nav">
      <nav class="sy-head-links"></nav>
      <div class="sy-head-extra flex items-center print:hidden"><form class="searchbox flex items-center" action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <kbd>/</kbd>
</form><div class="sy-head-socials">
  <a href="https://github.com/Haozeke/rgpycrumbs" aria-label="GitHub">
    <iconify-icon icon="simple-icons:github"></iconify-icon>
  </a></div></div>
    </div>
    <div class="sy-head-actions flex items-center shrink-0 print:hidden"><button class="js-theme theme-switch flex items-center"
data-aria-auto="Switch to light color mode"
data-aria-light="Switch to dark color mode"
data-aria-dark="Switch to auto color mode">
<i class="i-lucide theme-icon"></i>
</button><button class="md:hidden flex items-center js-menu" aria-label="Menu" type="button" aria-controls="head-nav" aria-expanded="false">
        <div class="hamburger">
          <span class="hamburger_1"></span>
          <span class="hamburger_2"></span>
          <span class="hamburger_3"></span>
        </div>
      </button>
    </div>
  </div>
</div>
<div class="sy-page sy-container flex mx-auto">
  <aside id="lside" class="sy-lside md:w-72 md:shrink-0 print:hidden">
    <div class="sy-lside-inner md:sticky">
      <div class="sy-scrollbar p-6">
        <div class="globaltoc" data-expand-depth="0"><p class="caption" role="heading" aria-level="3"><span class="caption-text">Tools</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tools/eon/index.html">eOn Helpers</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../tools/eon/con_splitter.html">Splitting <code class="docutils literal notranslate"><span class="pre">con</span></code> files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tools/eon/generate_nwchem_input.html">Generators for NWChem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tools/eon/mlflow.html">MLFlow Logging for eOn</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tools/eon/plt_neb.html">Plotting NEB paths</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tools/eon/ptmdisp.html">Polyhedral Template Matcher</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/geom/index.html">Geometry Helpers</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../tools/geom/alignment.html">Robust Structural Alignment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tools/geom/detect_fragments.html">Fragment Detection</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/utils/index.html">General Utilities</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../tools/utils/jupyter.html">Jupyter Notebook Helpers</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/prefix/index.html">Prefix Helpers</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../tools/prefix/delete_packages.html">Prefix Channel Package Deletion</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading" aria-level="3"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../used_by.html">Used By</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devnotes.html"><code class="docutils literal notranslate"><span class="pre">rgpycrumbs</span></code> Design &amp; Architecture Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/index.html">Contributing to <code class="docutils literal notranslate"><span class="pre">rgpycrumbs</span></code></a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../contributing/doc_builds.html">Documentation Standards &amp; Authoring</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../contributing/test_requirements.html">Testing &amp; Environment Requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../code_of_conduct.html">Code of Conduct</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../contributing/release.html">Release Management</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../autoapi/index.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../autoapi/helpers/index.html">helpers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../autoapi/rgpycrumbs/index.html">rgpycrumbs</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../autoapi/rgpycrumbs/_aux/index.html">rgpycrumbs._aux</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../autoapi/rgpycrumbs/basetypes/index.html">rgpycrumbs.basetypes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../autoapi/rgpycrumbs/cli/index.html">rgpycrumbs.cli</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../autoapi/rgpycrumbs/eon/index.html">rgpycrumbs.eon</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/rgpycrumbs/eon/_mlflow/index.html">rgpycrumbs.eon._mlflow</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/rgpycrumbs/eon/con_splitter/index.html">rgpycrumbs.eon.con_splitter</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/rgpycrumbs/eon/generate_nwchem_input/index.html">rgpycrumbs.eon.generate_nwchem_input</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/rgpycrumbs/eon/helpers/index.html">rgpycrumbs.eon.helpers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/rgpycrumbs/eon/plt_neb/index.html">rgpycrumbs.eon.plt_neb</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/rgpycrumbs/eon/ptmdisp/index.html">rgpycrumbs.eon.ptmdisp</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/rgpycrumbs/eon/to_mlflow/index.html">rgpycrumbs.eon.to_mlflow</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../autoapi/rgpycrumbs/func/index.html">rgpycrumbs.func</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/rgpycrumbs/func/muller_brown/index.html">rgpycrumbs.func.muller_brown</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../autoapi/rgpycrumbs/geom/index.html">rgpycrumbs.geom</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/rgpycrumbs/geom/analysis/index.html">rgpycrumbs.geom.analysis</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/rgpycrumbs/geom/api/index.html">rgpycrumbs.geom.api</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/rgpycrumbs/geom/detect_fragments/index.html">rgpycrumbs.geom.detect_fragments</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/rgpycrumbs/geom/ira/index.html">rgpycrumbs.geom.ira</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../autoapi/rgpycrumbs/interpolation/index.html">rgpycrumbs.interpolation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../autoapi/rgpycrumbs/parsers/index.html">rgpycrumbs.parsers</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/rgpycrumbs/parsers/bless/index.html">rgpycrumbs.parsers.bless</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/rgpycrumbs/parsers/common/index.html">rgpycrumbs.parsers.common</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../autoapi/rgpycrumbs/plumed/index.html">rgpycrumbs.plumed</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/rgpycrumbs/plumed/direct_reconstruction/index.html">rgpycrumbs.plumed.direct_reconstruction</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../autoapi/rgpycrumbs/prefix/index.html">rgpycrumbs.prefix</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/rgpycrumbs/prefix/delete_packages/index.html">rgpycrumbs.prefix.delete_packages</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../autoapi/rgpycrumbs/run/index.html">rgpycrumbs.run</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/rgpycrumbs/run/jupyter/index.html">rgpycrumbs.run.jupyter</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../autoapi/rgpycrumbs/surfaces/index.html">rgpycrumbs.surfaces</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../autoapi/rgpycrumbs/xts/index.html">rgpycrumbs.xts</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/rgpycrumbs/xts/cuh2/index.html">rgpycrumbs.xts.cuh2</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/rgpycrumbs/xts/saddle/index.html">rgpycrumbs.xts.saddle</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </div>
  </aside>
  <div class="lside-overlay js-menu" role="button" aria-label="Close left sidebar" aria-controls="lside" aria-expanded="false"></div>
  <aside id="rside" class="sy-rside pb-3 w-64 shrink-0 order-last">
    <button class="rside-close js-menu xl:hidden" aria-label="Close Table of Contents" type="button" aria-controls="rside" aria-expanded="false">
      <i class="i-lucide close"></i>
    </button>
    <div class="sy-scrollbar sy-rside-inner px-6 xl:top-16 xl:sticky xl:pl-0 pt-6 pb-4"><div id="ethical-ad-placement" data-ea-publisher="readthedocs"></div></div>
  </aside>
  <div class="rside-overlay js-menu" role="button" aria-label="Close Table of Contents" aria-controls="rside" aria-expanded="false"></div>
  <main class="sy-main w-full max-sm:max-w-full print:pt-6">
<div class="sy-breadcrumbs" role="navigation">
  <div class="sy-breadcrumbs-inner flex items-center">
    <div class="md:hidden mr-3">
      <button class="js-menu" aria-label="Menu" type="button" aria-controls="lside" aria-expanded="false">
        <i class="i-lucide menu"></i>
      </button>
    </div>
    <ol class="flex-1" itemscope itemtype="https://schema.org/BreadcrumbList"><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../../index.html"><span itemprop="name">rgpycrumbs</span></a>
        <span>/</span>
        <meta itemprop="position" content="1" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../index.html"><span itemprop="name">Module code</span></a>
        <span>/</span>
        <meta itemprop="position" content="2" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../rgpycrumbs.html"><span itemprop="name">rgpycrumbs</span></a>
        <span>/</span>
        <meta itemprop="position" content="3" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <strong itemprop="name">rgpycrumbs.surfaces</strong>
        <meta itemprop="position" content="4" />
      </li></ol>
    <div class="xl:hidden ml-1">
      <button class="js-menu" aria-label="Show table of contents" type="button" aria-controls="rside"
        aria-expanded="false">
        <i class="i-lucide outdent"></i>
      </button>
    </div>
  </div>
</div><div class="flex flex-col break-words justify-between">
      <div class="relative min-w-0 max-w-6xl px-6 pb-6 pt-8 xl:px-12">
  <article class="yue" role="main">
          <h1>Source code for rgpycrumbs.surfaces</h1><div class="highlight"><pre>
<span></span><span data-line="1"><span class="kn">import</span><span class="w"> </span><span class="nn">jax</span>
</span><span data-line="2"><span class="kn">import</span><span class="w"> </span><span class="nn">jax.numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">jnp</span>
</span><span data-line="3"><span class="kn">import</span><span class="w"> </span><span class="nn">jax.scipy.optimize</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">jopt</span>
</span><span data-line="4"><span class="kn">from</span><span class="w"> </span><span class="nn">jax</span><span class="w"> </span><span class="kn">import</span> <span class="n">jit</span><span class="p">,</span> <span class="n">vmap</span>
</span><span data-line="5">
</span><span data-line="6"><span class="c1"># Force float32 for speed/viz</span>
</span><span data-line="7"><span class="n">jax</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s2">&quot;jax_enable_x64&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span data-line="8">
</span><span data-line="9"><span class="c1"># ==============================================================================</span>
</span><span data-line="10"><span class="c1"># HELPER: GENERIC LOSS FUNCTIONS</span>
</span><span data-line="11"><span class="c1"># ==============================================================================</span>
</span><span data-line="12">
</span><span data-line="13">
<div class="viewcode-block" id="safe_cholesky_solve">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.safe_cholesky_solve">[docs]</a>
</span><span data-line="14"><span class="k">def</span><span class="w"> </span><span class="nf">safe_cholesky_solve</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">noise_scalar</span><span class="p">,</span> <span class="n">jitter_steps</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
</span><span data-line="15"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Retries Cholesky with increasing jitter if it fails.&quot;&quot;&quot;</span>
</span><span data-line="16">    <span class="n">N</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span data-line="17">
</span><span data-line="18">    <span class="c1"># Try successively larger jitters: 1e-6, 1e-5, 1e-4</span>
</span><span data-line="19">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">jitter_steps</span><span class="p">):</span>
</span><span data-line="20">        <span class="n">jitter</span> <span class="o">=</span> <span class="p">(</span><span class="n">noise_scalar</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">6</span> <span class="o">+</span> <span class="n">i</span><span class="p">))</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
</span><span data-line="21">        <span class="k">try</span><span class="p">:</span>
</span><span data-line="22">            <span class="n">L</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">K</span> <span class="o">+</span> <span class="n">jitter</span><span class="p">)</span>
</span><span data-line="23">            <span class="n">alpha</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
</span><span data-line="24">            <span class="n">log_det</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">L</span><span class="p">)))</span>
</span><span data-line="25">            <span class="k">return</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">log_det</span>
</span><span data-line="26">        <span class="k">except</span><span class="p">:</span>
</span><span data-line="27">            <span class="k">continue</span>
</span><span data-line="28">
</span><span data-line="29">    <span class="c1"># Fallback for compilation safety (NaN propagation)</span>
</span><span data-line="30">    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">nan</span></div>

</span><span data-line="31">
</span><span data-line="32">
<div class="viewcode-block" id="generic_negative_mll">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.generic_negative_mll">[docs]</a>
</span><span data-line="33"><span class="k">def</span><span class="w"> </span><span class="nf">generic_negative_mll</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">noise_scalar</span><span class="p">):</span>
</span><span data-line="34">    <span class="n">alpha</span><span class="p">,</span> <span class="n">log_det</span> <span class="o">=</span> <span class="n">safe_cholesky_solve</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">noise_scalar</span><span class="p">)</span>
</span><span data-line="35">
</span><span data-line="36">    <span class="n">data_fit</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">alpha</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
</span><span data-line="37">    <span class="n">complexity</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">log_det</span>
</span><span data-line="38">
</span><span data-line="39">    <span class="n">cost</span> <span class="o">=</span> <span class="n">data_fit</span> <span class="o">+</span> <span class="n">complexity</span>
</span><span data-line="40">    <span class="c1"># heavy penalty if Cholesky failed (NaN)</span>
</span><span data-line="41">    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">cost</span><span class="p">),</span> <span class="mf">1e9</span><span class="p">,</span> <span class="n">cost</span><span class="p">)</span></div>

</span><span data-line="42">
</span><span data-line="43">
</span><span data-line="44"><span class="c1"># ==============================================================================</span>
</span><span data-line="45"><span class="c1"># 1. TPS IMPLEMENTATION (Optimizable)</span>
</span><span data-line="46"><span class="c1"># ==============================================================================</span>
</span><span data-line="47">
</span><span data-line="48">
</span><span data-line="49"><span class="nd">@jit</span>
<div class="viewcode-block" id="_tps_kernel_matrix">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces._tps_kernel_matrix">[docs]</a>
</span><span data-line="50"><span class="k">def</span><span class="w"> </span><span class="nf">_tps_kernel_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span data-line="51">    <span class="n">d2</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="52">    <span class="n">r</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">d2</span> <span class="o">+</span> <span class="mf">1e-12</span><span class="p">)</span>
</span><span data-line="53">    <span class="n">K</span> <span class="o">=</span> <span class="n">r</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</span><span data-line="54">    <span class="k">return</span> <span class="n">K</span></div>

</span><span data-line="55">
</span><span data-line="56">
<div class="viewcode-block" id="negative_mll_tps">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.negative_mll_tps">[docs]</a>
</span><span data-line="57"><span class="k">def</span><span class="w"> </span><span class="nf">negative_mll_tps</span><span class="p">(</span><span class="n">log_params</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span><span data-line="58">    <span class="c1"># TPS only really has a smoothing parameter to tune in this context</span>
</span><span data-line="59">    <span class="c1"># (Length scale is inherent to the radial basis).</span>
</span><span data-line="60">    <span class="n">smoothing</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_params</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span data-line="61">    <span class="n">K</span> <span class="o">=</span> <span class="n">_tps_kernel_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span data-line="62">    <span class="k">return</span> <span class="n">generic_negative_mll</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">smoothing</span><span class="p">)</span></div>

</span><span data-line="63">
</span><span data-line="64">
</span><span data-line="65"><span class="nd">@jit</span>
<div class="viewcode-block" id="_tps_solve">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces._tps_solve">[docs]</a>
</span><span data-line="66"><span class="k">def</span><span class="w"> </span><span class="nf">_tps_solve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sm</span><span class="p">):</span>
</span><span data-line="67">    <span class="n">K</span> <span class="o">=</span> <span class="n">_tps_kernel_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span data-line="68">    <span class="n">K</span> <span class="o">=</span> <span class="n">K</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">sm</span>
</span><span data-line="69">
</span><span data-line="70">    <span class="c1"># Polynomial Matrix</span>
</span><span data-line="71">    <span class="n">N</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span data-line="72">    <span class="n">P</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">x</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="73">    <span class="n">M</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span data-line="74">
</span><span data-line="75">    <span class="c1"># Solve System</span>
</span><span data-line="76">    <span class="n">zeros</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">M</span><span class="p">,</span> <span class="n">M</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span data-line="77">    <span class="n">top</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">K</span><span class="p">,</span> <span class="n">P</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="78">    <span class="n">bot</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">P</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">zeros</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="79">    <span class="n">lhs</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">top</span><span class="p">,</span> <span class="n">bot</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span data-line="80">    <span class="n">rhs</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">y</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)])</span>
</span><span data-line="81">
</span><span data-line="82">    <span class="n">coeffs</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
</span><span data-line="83">    <span class="k">return</span> <span class="n">coeffs</span><span class="p">[:</span><span class="n">N</span><span class="p">],</span> <span class="n">coeffs</span><span class="p">[</span><span class="n">N</span><span class="p">:]</span></div>

</span><span data-line="84">
</span><span data-line="85">
</span><span data-line="86"><span class="nd">@jit</span>
<div class="viewcode-block" id="_tps_predict">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces._tps_predict">[docs]</a>
</span><span data-line="87"><span class="k">def</span><span class="w"> </span><span class="nf">_tps_predict</span><span class="p">(</span><span class="n">x_query</span><span class="p">,</span> <span class="n">x_obs</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
</span><span data-line="88">    <span class="n">d2</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x_query</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">x_obs</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="89">    <span class="n">r</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">d2</span> <span class="o">+</span> <span class="mf">1e-12</span><span class="p">)</span>
</span><span data-line="90">    <span class="n">K_q</span> <span class="o">=</span> <span class="n">r</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</span><span data-line="91">
</span><span data-line="92">    <span class="n">P_q</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
</span><span data-line="93">        <span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">x_query</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">x_query</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
</span><span data-line="94">    <span class="p">)</span>
</span><span data-line="95">    <span class="k">return</span> <span class="n">K_q</span> <span class="o">@</span> <span class="n">w</span> <span class="o">+</span> <span class="n">P_q</span> <span class="o">@</span> <span class="n">v</span></div>

</span><span data-line="96">
</span><span data-line="97">
<div class="viewcode-block" id="FastTPS">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.FastTPS">[docs]</a>
</span><span data-line="98"><span class="k">class</span><span class="w"> </span><span class="nc">FastTPS</span><span class="p">:</span>
</span><span data-line="99">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_obs</span><span class="p">,</span> <span class="n">y_obs</span><span class="p">,</span> <span class="n">smoothing</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<div class="viewcode-block" id="FastTPS.x_obs">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.FastTPS.x_obs">[docs]</a>
</span><span data-line="100">        <span class="bp">self</span><span class="o">.</span><span class="n">x_obs</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x_obs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span></div>

<div class="viewcode-block" id="FastTPS.y_obs">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.FastTPS.y_obs">[docs]</a>
</span><span data-line="101">        <span class="bp">self</span><span class="o">.</span><span class="n">y_obs</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_obs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span></div>

</span><span data-line="102">
</span><span data-line="103">        <span class="c1"># TPS handles mean via polynomial, but centering helps optimization stability</span>
<div class="viewcode-block" id="FastTPS.y_mean">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.FastTPS.y_mean">[docs]</a>
</span><span data-line="104">        <span class="bp">self</span><span class="o">.</span><span class="n">y_mean</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_obs</span><span class="p">)</span></div>

</span><span data-line="105">        <span class="n">y_centered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_obs</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_mean</span>
</span><span data-line="106">
</span><span data-line="107">        <span class="n">init_sm</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">smoothing</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">)</span>
</span><span data-line="108">
</span><span data-line="109">        <span class="k">if</span> <span class="n">optimize</span><span class="p">:</span>
</span><span data-line="110">            <span class="c1"># Optimize [log_smoothing]</span>
</span><span data-line="111">            <span class="n">x0</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">init_sm</span><span class="p">)])</span>
</span><span data-line="112">
</span><span data-line="113">            <span class="k">def</span><span class="w"> </span><span class="nf">loss_fn</span><span class="p">(</span><span class="n">log_p</span><span class="p">):</span>
</span><span data-line="114">                <span class="k">return</span> <span class="n">negative_mll_tps</span><span class="p">(</span><span class="n">log_p</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_obs</span><span class="p">,</span> <span class="n">y_centered</span><span class="p">)</span>
</span><span data-line="115">
</span><span data-line="116">            <span class="n">results</span> <span class="o">=</span> <span class="n">jopt</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">loss_fn</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;BFGS&quot;</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
</span><span data-line="117">
</span><span data-line="118">            <span class="bp">self</span><span class="o">.</span><span class="n">sm</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span data-line="119">            <span class="k">if</span> <span class="n">jnp</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sm</span><span class="p">):</span>
</span><span data-line="120">                <span class="bp">self</span><span class="o">.</span><span class="n">sm</span> <span class="o">=</span> <span class="n">init_sm</span>
</span><span data-line="121">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="122">            <span class="bp">self</span><span class="o">.</span><span class="n">sm</span> <span class="o">=</span> <span class="n">init_sm</span>
</span><span data-line="123">
</span><span data-line="124">        <span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">_tps_solve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_obs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_obs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sm</span><span class="p">)</span>
</span><span data-line="125">
<div class="viewcode-block" id="FastTPS.__call__">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.FastTPS.__call__">[docs]</a>
</span><span data-line="126">    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_query</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
</span><span data-line="127"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="128"><span class="sd">        Batched prediction to prevent OOM errors on large grids.</span>
</span><span data-line="129"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="130">        <span class="n">x_query</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x_query</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span data-line="131">        <span class="n">preds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="132">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x_query</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">chunk_size</span><span class="p">):</span>
</span><span data-line="133">            <span class="n">chunk</span> <span class="o">=</span> <span class="n">x_query</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">chunk_size</span><span class="p">]</span>
</span><span data-line="134">            <span class="n">preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_tps_predict</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_obs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">))</span>
</span><span data-line="135">        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>
</div>

</span><span data-line="136">
</span><span data-line="137">
</span><span data-line="138"><span class="c1"># ==============================================================================</span>
</span><span data-line="139"><span class="c1"># 2. MATERN 5/2</span>
</span><span data-line="140"><span class="c1"># ==============================================================================</span>
</span><span data-line="141">
</span><span data-line="142">
</span><span data-line="143"><span class="nd">@jit</span>
<div class="viewcode-block" id="_matern_kernel_matrix">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces._matern_kernel_matrix">[docs]</a>
</span><span data-line="144"><span class="k">def</span><span class="w"> </span><span class="nf">_matern_kernel_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">length_scale</span><span class="p">):</span>
</span><span data-line="145">    <span class="n">d2</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="146">    <span class="n">r</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">d2</span> <span class="o">+</span> <span class="mf">1e-12</span><span class="p">)</span>
</span><span data-line="147">
</span><span data-line="148">    <span class="c1"># Mat√©rn 5/2 Kernel</span>
</span><span data-line="149">    <span class="c1"># k(r) = (1 + sqrt(5)r/l + 5r^2/3l^2) * exp(-sqrt(5)r/l)</span>
</span><span data-line="150">    <span class="n">sqrt5_r_l</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">5.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">r</span> <span class="o">/</span> <span class="n">length_scale</span>
</span><span data-line="151">    <span class="n">K</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">sqrt5_r_l</span> <span class="o">+</span> <span class="p">(</span><span class="mf">5.0</span> <span class="o">*</span> <span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">3.0</span> <span class="o">*</span> <span class="n">length_scale</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">sqrt5_r_l</span><span class="p">)</span>
</span><span data-line="152">    <span class="k">return</span> <span class="n">K</span></div>

</span><span data-line="153">
</span><span data-line="154">
<div class="viewcode-block" id="negative_mll_matern_std">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.negative_mll_matern_std">[docs]</a>
</span><span data-line="155"><span class="k">def</span><span class="w"> </span><span class="nf">negative_mll_matern_std</span><span class="p">(</span><span class="n">log_params</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span><span data-line="156">    <span class="n">length_scale</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_params</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span data-line="157">    <span class="n">noise_scalar</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_params</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span data-line="158">    <span class="n">K</span> <span class="o">=</span> <span class="n">_matern_kernel_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">length_scale</span><span class="p">)</span>
</span><span data-line="159">    <span class="k">return</span> <span class="n">generic_negative_mll</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">noise_scalar</span><span class="p">)</span></div>

</span><span data-line="160">
</span><span data-line="161">
</span><span data-line="162"><span class="nd">@jit</span>
<div class="viewcode-block" id="_matern_solve">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces._matern_solve">[docs]</a>
</span><span data-line="163"><span class="k">def</span><span class="w"> </span><span class="nf">_matern_solve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="n">length_scale</span><span class="p">):</span>
</span><span data-line="164">    <span class="n">K</span> <span class="o">=</span> <span class="n">_matern_kernel_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">length_scale</span><span class="p">)</span>
</span><span data-line="165">    <span class="n">K</span> <span class="o">=</span> <span class="n">K</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">sm</span>
</span><span data-line="166">    <span class="c1"># 3. Solve (Cholesky is faster/stable for positive definite kernels like Mat√©rn)</span>
</span><span data-line="167">    <span class="c1"># Note: We don&#39;t use the polynomial &#39;P&#39; matrix here usually, as Mat√©rn</span>
</span><span data-line="168">    <span class="c1"># decays to mean zero. If you want it to revert to a mean value, subtract</span>
</span><span data-line="169">    <span class="c1"># mean(y) before fitting and add it back after.</span>
</span><span data-line="170">    <span class="n">L</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
</span><span data-line="171">    <span class="n">alpha</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
</span><span data-line="172">    <span class="k">return</span> <span class="n">alpha</span></div>

</span><span data-line="173">
</span><span data-line="174">
</span><span data-line="175"><span class="nd">@jit</span>
<div class="viewcode-block" id="_matern_predict">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces._matern_predict">[docs]</a>
</span><span data-line="176"><span class="k">def</span><span class="w"> </span><span class="nf">_matern_predict</span><span class="p">(</span><span class="n">x_query</span><span class="p">,</span> <span class="n">x_obs</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">length_scale</span><span class="p">):</span>
</span><span data-line="177">    <span class="n">d2</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x_query</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">x_obs</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="178">    <span class="n">r</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">d2</span> <span class="o">+</span> <span class="mf">1e-12</span><span class="p">)</span>
</span><span data-line="179">
</span><span data-line="180">    <span class="n">sqrt5_r_l</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">5.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">r</span> <span class="o">/</span> <span class="n">length_scale</span>
</span><span data-line="181">    <span class="n">K_q</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">sqrt5_r_l</span> <span class="o">+</span> <span class="p">(</span><span class="mf">5.0</span> <span class="o">*</span> <span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">3.0</span> <span class="o">*</span> <span class="n">length_scale</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
</span><span data-line="182">        <span class="o">-</span><span class="n">sqrt5_r_l</span>
</span><span data-line="183">    <span class="p">)</span>
</span><span data-line="184">
</span><span data-line="185">    <span class="k">return</span> <span class="n">K_q</span> <span class="o">@</span> <span class="n">alpha</span></div>

</span><span data-line="186">
</span><span data-line="187">
<div class="viewcode-block" id="FastMatern">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.FastMatern">[docs]</a>
</span><span data-line="188"><span class="k">class</span><span class="w"> </span><span class="nc">FastMatern</span><span class="p">:</span>
</span><span data-line="189">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span data-line="190">        <span class="bp">self</span><span class="p">,</span> <span class="n">x_obs</span><span class="p">,</span> <span class="n">y_obs</span><span class="p">,</span> <span class="n">smoothing</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">length_scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
</span><span data-line="191">    <span class="p">):</span>
<div class="viewcode-block" id="FastMatern.x_obs">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.FastMatern.x_obs">[docs]</a>
</span><span data-line="192">        <span class="bp">self</span><span class="o">.</span><span class="n">x_obs</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x_obs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span></div>

<div class="viewcode-block" id="FastMatern.y_obs">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.FastMatern.y_obs">[docs]</a>
</span><span data-line="193">        <span class="bp">self</span><span class="o">.</span><span class="n">y_obs</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_obs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span></div>

</span><span data-line="194">        <span class="c1"># Center the data (important for stationary kernels like Mat√©rn)</span>
<div class="viewcode-block" id="FastMatern.y_mean">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.FastMatern.y_mean">[docs]</a>
</span><span data-line="195">        <span class="bp">self</span><span class="o">.</span><span class="n">y_mean</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_obs</span><span class="p">)</span></div>

</span><span data-line="196">        <span class="n">y_centered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_obs</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_mean</span>
</span><span data-line="197">
</span><span data-line="198">        <span class="c1"># Heuristic</span>
</span><span data-line="199">        <span class="k">if</span> <span class="n">length_scale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="200">            <span class="c1"># Simple heuristic: sqrt(span) / 2 is often a safe start for density</span>
</span><span data-line="201">            <span class="n">span</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_obs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">jnp</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_obs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span data-line="202">            <span class="n">init_ls</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">span</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.2</span>
</span><span data-line="203">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="204">            <span class="n">init_ls</span> <span class="o">=</span> <span class="n">length_scale</span>
</span><span data-line="205">
</span><span data-line="206">        <span class="n">init_noise</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">smoothing</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">)</span>
</span><span data-line="207">
</span><span data-line="208">        <span class="k">if</span> <span class="n">optimize</span><span class="p">:</span>
</span><span data-line="209">            <span class="c1"># Optimize [log_ls, log_noise]</span>
</span><span data-line="210">            <span class="n">x0</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">init_ls</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">init_noise</span><span class="p">)])</span>
</span><span data-line="211">
</span><span data-line="212">            <span class="k">def</span><span class="w"> </span><span class="nf">loss_fn</span><span class="p">(</span><span class="n">log_p</span><span class="p">):</span>
</span><span data-line="213">                <span class="k">return</span> <span class="n">negative_mll_matern_std</span><span class="p">(</span><span class="n">log_p</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_obs</span><span class="p">,</span> <span class="n">y_centered</span><span class="p">)</span>
</span><span data-line="214">
</span><span data-line="215">            <span class="n">results</span> <span class="o">=</span> <span class="n">jopt</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">loss_fn</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;BFGS&quot;</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
</span><span data-line="216">            <span class="bp">self</span><span class="o">.</span><span class="n">ls</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span data-line="217">            <span class="bp">self</span><span class="o">.</span><span class="n">noise</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</span><span data-line="218">
</span><span data-line="219">            <span class="k">if</span> <span class="n">jnp</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ls</span><span class="p">)</span> <span class="ow">or</span> <span class="n">jnp</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="p">):</span>
</span><span data-line="220">                <span class="bp">self</span><span class="o">.</span><span class="n">ls</span> <span class="o">=</span> <span class="n">init_ls</span>
</span><span data-line="221">                <span class="bp">self</span><span class="o">.</span><span class="n">noise</span> <span class="o">=</span> <span class="n">init_noise</span>
</span><span data-line="222">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="223">            <span class="bp">self</span><span class="o">.</span><span class="n">ls</span> <span class="o">=</span> <span class="n">init_ls</span>
</span><span data-line="224">            <span class="bp">self</span><span class="o">.</span><span class="n">noise</span> <span class="o">=</span> <span class="n">init_noise</span>
</span><span data-line="225">
<div class="viewcode-block" id="FastMatern.alpha">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.FastMatern.alpha">[docs]</a>
</span><span data-line="226">        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">_matern_solve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_obs</span><span class="p">,</span> <span class="n">y_centered</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ls</span><span class="p">)</span></div>

</span><span data-line="227">
<div class="viewcode-block" id="FastMatern.__call__">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.FastMatern.__call__">[docs]</a>
</span><span data-line="228">    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_query</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
</span><span data-line="229"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="230"><span class="sd">        Batched prediction for Matern.</span>
</span><span data-line="231"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="232">        <span class="n">x_query</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x_query</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span data-line="233">        <span class="n">preds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="234">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x_query</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">chunk_size</span><span class="p">):</span>
</span><span data-line="235">            <span class="n">chunk</span> <span class="o">=</span> <span class="n">x_query</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">chunk_size</span><span class="p">]</span>
</span><span data-line="236">            <span class="n">preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_matern_predict</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_obs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ls</span><span class="p">))</span>
</span><span data-line="237">        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_mean</span></div>
</div>

</span><span data-line="238">
</span><span data-line="239">
</span><span data-line="240"><span class="c1"># ==============================================================================</span>
</span><span data-line="241"><span class="c1"># 3. GRADIENT-ENHANCED MATERN</span>
</span><span data-line="242"><span class="c1"># ==============================================================================</span>
</span><span data-line="243">
</span><span data-line="244">
<div class="viewcode-block" id="matern_kernel_elem">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.matern_kernel_elem">[docs]</a>
</span><span data-line="245"><span class="k">def</span><span class="w"> </span><span class="nf">matern_kernel_elem</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">length_scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
</span><span data-line="246">    <span class="n">d2</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
</span><span data-line="247">    <span class="n">r</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">d2</span> <span class="o">+</span> <span class="mf">1e-12</span><span class="p">)</span>
</span><span data-line="248">    <span class="n">ls</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">length_scale</span><span class="p">)</span>
</span><span data-line="249">    <span class="n">sqrt5_r_l</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">5.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">r</span> <span class="o">/</span> <span class="n">ls</span>
</span><span data-line="250">    <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">sqrt5_r_l</span> <span class="o">+</span> <span class="p">(</span><span class="mf">5.0</span> <span class="o">*</span> <span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">3.0</span> <span class="o">*</span> <span class="n">ls</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">sqrt5_r_l</span><span class="p">)</span>
</span><span data-line="251">    <span class="k">return</span> <span class="n">val</span></div>

</span><span data-line="252">
</span><span data-line="253">
</span><span data-line="254"><span class="c1"># --- Auto-Diff the Kernel to get Gradient Covariances ---</span>
</span><span data-line="255"><span class="c1"># This creates a function that returns the (D+1)x(D+1) covariance block</span>
</span><span data-line="256"><span class="c1"># [ Cov(E, E)    Cov(E, dX)    Cov(E, dY) ]</span>
</span><span data-line="257"><span class="c1"># [ Cov(dX, E)   Cov(dX, dX)   Cov(dX, dY) ]</span>
</span><span data-line="258"><span class="c1"># [ Cov(dY, E)   Cov(dY, dX)   Cov(dY, dY) ]</span>
<div class="viewcode-block" id="full_covariance_matern">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.full_covariance_matern">[docs]</a>
</span><span data-line="259"><span class="k">def</span><span class="w"> </span><span class="nf">full_covariance_matern</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">length_scale</span><span class="p">):</span>
</span><span data-line="260">    <span class="n">k_ee</span> <span class="o">=</span> <span class="n">matern_kernel_elem</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">length_scale</span><span class="p">)</span>
</span><span data-line="261">    <span class="n">k_ed</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">matern_kernel_elem</span><span class="p">,</span> <span class="n">argnums</span><span class="o">=</span><span class="mi">1</span><span class="p">)(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">length_scale</span><span class="p">)</span>
</span><span data-line="262">    <span class="n">k_de</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">matern_kernel_elem</span><span class="p">,</span> <span class="n">argnums</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">length_scale</span><span class="p">)</span>
</span><span data-line="263">    <span class="n">k_dd</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">jacfwd</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">matern_kernel_elem</span><span class="p">,</span> <span class="n">argnums</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">argnums</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span>
</span><span data-line="264">        <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">length_scale</span>
</span><span data-line="265">    <span class="p">)</span>
</span><span data-line="266">    <span class="c1"># Top row: [E-E, E-dx, E-dy]</span>
</span><span data-line="267">    <span class="n">row1</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">k_ee</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="n">k_ed</span><span class="p">])</span>
</span><span data-line="268">    <span class="c1"># Bottom rows: [dx-E,  dx-dx, dx-dy]</span>
</span><span data-line="269">    <span class="c1">#              [dy-E,  dy-dx, dy-dy]</span>
</span><span data-line="270">    <span class="n">row2</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">k_de</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">k_dd</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="271">    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">row1</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">row2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>

</span><span data-line="272">
</span><span data-line="273">
<div class="viewcode-block" id="k_matrix_matern_grad_map">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.k_matrix_matern_grad_map">[docs]</a>
</span><span data-line="274"><span class="n">k_matrix_matern_grad_map</span> <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span>
</span><span data-line="275">    <span class="n">vmap</span><span class="p">(</span><span class="n">full_covariance_matern</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span data-line="276"><span class="p">)</span></div>

</span><span data-line="277">
</span><span data-line="278">
<div class="viewcode-block" id="negative_mll_matern_grad">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.negative_mll_matern_grad">[docs]</a>
</span><span data-line="279"><span class="k">def</span><span class="w"> </span><span class="nf">negative_mll_matern_grad</span><span class="p">(</span><span class="n">log_params</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y_flat</span><span class="p">,</span> <span class="n">D_plus_1</span><span class="p">):</span>
</span><span data-line="280">    <span class="n">length_scale</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_params</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span data-line="281">    <span class="n">noise_scalar</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_params</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span data-line="282">    <span class="n">K_blocks</span> <span class="o">=</span> <span class="n">k_matrix_matern_grad_map</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">length_scale</span><span class="p">)</span>
</span><span data-line="283">    <span class="n">N</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span data-line="284">    <span class="n">K_full</span> <span class="o">=</span> <span class="n">K_blocks</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="n">D_plus_1</span><span class="p">,</span> <span class="n">N</span> <span class="o">*</span> <span class="n">D_plus_1</span><span class="p">)</span>
</span><span data-line="285">    <span class="k">return</span> <span class="n">generic_negative_mll</span><span class="p">(</span><span class="n">K_full</span><span class="p">,</span> <span class="n">y_flat</span><span class="p">,</span> <span class="n">noise_scalar</span><span class="p">)</span></div>

</span><span data-line="286">
</span><span data-line="287">
</span><span data-line="288"><span class="nd">@jit</span>
<div class="viewcode-block" id="_grad_matern_solve">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces._grad_matern_solve">[docs]</a>
</span><span data-line="289"><span class="k">def</span><span class="w"> </span><span class="nf">_grad_matern_solve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y_full</span><span class="p">,</span> <span class="n">noise_scalar</span><span class="p">,</span> <span class="n">length_scale</span><span class="p">):</span>
</span><span data-line="290">    <span class="n">K_blocks</span> <span class="o">=</span> <span class="n">k_matrix_matern_grad_map</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">length_scale</span><span class="p">)</span>
</span><span data-line="291">    <span class="n">N</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">D_plus_1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">K_blocks</span><span class="o">.</span><span class="n">shape</span>
</span><span data-line="292">    <span class="n">K_full</span> <span class="o">=</span> <span class="n">K_blocks</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="n">D_plus_1</span><span class="p">,</span> <span class="n">N</span> <span class="o">*</span> <span class="n">D_plus_1</span><span class="p">)</span>
</span><span data-line="293">    <span class="n">diag_noise</span> <span class="o">=</span> <span class="p">(</span><span class="n">noise_scalar</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="n">D_plus_1</span><span class="p">)</span>
</span><span data-line="294">    <span class="n">K_full</span> <span class="o">=</span> <span class="n">K_full</span> <span class="o">+</span> <span class="n">diag_noise</span>
</span><span data-line="295">    <span class="n">alpha</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">K_full</span><span class="p">,</span> <span class="n">y_full</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
</span><span data-line="296">    <span class="k">return</span> <span class="n">alpha</span></div>

</span><span data-line="297">
</span><span data-line="298">
</span><span data-line="299"><span class="nd">@jit</span>
<div class="viewcode-block" id="_grad_matern_predict">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces._grad_matern_predict">[docs]</a>
</span><span data-line="300"><span class="k">def</span><span class="w"> </span><span class="nf">_grad_matern_predict</span><span class="p">(</span><span class="n">x_query</span><span class="p">,</span> <span class="n">x_obs</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">length_scale</span><span class="p">):</span>
</span><span data-line="301">    <span class="k">def</span><span class="w"> </span><span class="nf">get_query_row</span><span class="p">(</span><span class="n">xq</span><span class="p">,</span> <span class="n">xo</span><span class="p">):</span>
</span><span data-line="302">        <span class="n">kee</span> <span class="o">=</span> <span class="n">matern_kernel_elem</span><span class="p">(</span><span class="n">xq</span><span class="p">,</span> <span class="n">xo</span><span class="p">,</span> <span class="n">length_scale</span><span class="p">)</span>
</span><span data-line="303">        <span class="n">ked</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">matern_kernel_elem</span><span class="p">,</span> <span class="n">argnums</span><span class="o">=</span><span class="mi">1</span><span class="p">)(</span><span class="n">xq</span><span class="p">,</span> <span class="n">xo</span><span class="p">,</span> <span class="n">length_scale</span><span class="p">)</span>
</span><span data-line="304">        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">kee</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="n">ked</span><span class="p">])</span>
</span><span data-line="305">
</span><span data-line="306">    <span class="n">K_q</span> <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="n">vmap</span><span class="p">(</span><span class="n">get_query_row</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">))(</span><span class="n">x_query</span><span class="p">,</span> <span class="n">x_obs</span><span class="p">)</span>
</span><span data-line="307">    <span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">D_plus_1</span> <span class="o">=</span> <span class="n">K_q</span><span class="o">.</span><span class="n">shape</span>
</span><span data-line="308">    <span class="k">return</span> <span class="n">K_q</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">N</span> <span class="o">*</span> <span class="n">D_plus_1</span><span class="p">)</span> <span class="o">@</span> <span class="n">alpha</span></div>

</span><span data-line="309">
</span><span data-line="310">
<div class="viewcode-block" id="GradientMatern">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.GradientMatern">[docs]</a>
</span><span data-line="311"><span class="k">class</span><span class="w"> </span><span class="nc">GradientMatern</span><span class="p">:</span>
</span><span data-line="312">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span data-line="313">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="314">        <span class="n">x</span><span class="p">,</span>
</span><span data-line="315">        <span class="n">y</span><span class="p">,</span>
</span><span data-line="316">        <span class="n">gradients</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span data-line="317">        <span class="n">smoothing</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>
</span><span data-line="318">        <span class="n">length_scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span data-line="319">        <span class="n">optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="320">        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span data-line="321">    <span class="p">):</span>
<div class="viewcode-block" id="GradientMatern.x">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.GradientMatern.x">[docs]</a>
</span><span data-line="322">        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span></div>

</span><span data-line="323">        <span class="n">y_energies</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span>
</span><span data-line="324">        <span class="n">grad_vals</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="325">            <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">gradients</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span data-line="326">            <span class="k">if</span> <span class="n">gradients</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="327">            <span class="k">else</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
</span><span data-line="328">        <span class="p">)</span>
</span><span data-line="329">
<div class="viewcode-block" id="GradientMatern.y_full">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.GradientMatern.y_full">[docs]</a>
</span><span data-line="330">        <span class="bp">self</span><span class="o">.</span><span class="n">y_full</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">y_energies</span><span class="p">,</span> <span class="n">grad_vals</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="GradientMatern.e_mean">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.GradientMatern.e_mean">[docs]</a>
</span><span data-line="331">        <span class="bp">self</span><span class="o">.</span><span class="n">e_mean</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_energies</span><span class="p">)</span></div>

</span><span data-line="332">        <span class="bp">self</span><span class="o">.</span><span class="n">y_full</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_full</span><span class="o">.</span><span class="n">at</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">e_mean</span><span class="p">)</span>
<div class="viewcode-block" id="GradientMatern.y_flat">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.GradientMatern.y_flat">[docs]</a>
</span><span data-line="333">        <span class="bp">self</span><span class="o">.</span><span class="n">y_flat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_full</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span></div>

</span><span data-line="334">        <span class="n">D_plus_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
</span><span data-line="335">
</span><span data-line="336">        <span class="k">if</span> <span class="n">length_scale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="337">            <span class="n">span</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">jnp</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span data-line="338">            <span class="n">init_ls</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">span</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>
</span><span data-line="339">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="340">            <span class="n">init_ls</span> <span class="o">=</span> <span class="n">length_scale</span>
</span><span data-line="341">        <span class="n">init_noise</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">smoothing</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">)</span>
</span><span data-line="342">
</span><span data-line="343">        <span class="k">if</span> <span class="n">optimize</span><span class="p">:</span>
</span><span data-line="344">            <span class="n">x0</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">init_ls</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">init_noise</span><span class="p">)])</span>
</span><span data-line="345">
</span><span data-line="346">            <span class="k">def</span><span class="w"> </span><span class="nf">loss_fn</span><span class="p">(</span><span class="n">log_p</span><span class="p">):</span>
</span><span data-line="347">                <span class="k">return</span> <span class="n">negative_mll_matern_grad</span><span class="p">(</span><span class="n">log_p</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_flat</span><span class="p">,</span> <span class="n">D_plus_1</span><span class="p">)</span>
</span><span data-line="348">
</span><span data-line="349">            <span class="n">results</span> <span class="o">=</span> <span class="n">jopt</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">loss_fn</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;BFGS&quot;</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
</span><span data-line="350">            <span class="bp">self</span><span class="o">.</span><span class="n">ls</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span data-line="351">            <span class="bp">self</span><span class="o">.</span><span class="n">noise</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</span><span data-line="352">            <span class="k">if</span> <span class="n">jnp</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ls</span><span class="p">)</span> <span class="ow">or</span> <span class="n">jnp</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="p">):</span>
</span><span data-line="353">                <span class="bp">self</span><span class="o">.</span><span class="n">ls</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span> <span class="o">=</span> <span class="n">init_ls</span><span class="p">,</span> <span class="n">init_noise</span>
</span><span data-line="354">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="355">            <span class="bp">self</span><span class="o">.</span><span class="n">ls</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span> <span class="o">=</span> <span class="n">init_ls</span><span class="p">,</span> <span class="n">init_noise</span>
</span><span data-line="356">
<div class="viewcode-block" id="GradientMatern.alpha">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.GradientMatern.alpha">[docs]</a>
</span><span data-line="357">        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">_grad_matern_solve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_full</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ls</span><span class="p">)</span></div>

</span><span data-line="358">
<div class="viewcode-block" id="GradientMatern.__call__">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.GradientMatern.__call__">[docs]</a>
</span><span data-line="359">    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_query</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
</span><span data-line="360">        <span class="n">x_query</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x_query</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span data-line="361">        <span class="n">preds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="362">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x_query</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">chunk_size</span><span class="p">):</span>
</span><span data-line="363">            <span class="n">chunk</span> <span class="o">=</span> <span class="n">x_query</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">chunk_size</span><span class="p">]</span>
</span><span data-line="364">            <span class="n">preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_grad_matern_predict</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ls</span><span class="p">))</span>
</span><span data-line="365">        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_mean</span></div>
</div>

</span><span data-line="366">
</span><span data-line="367">
</span><span data-line="368"><span class="c1"># ==============================================================================</span>
</span><span data-line="369"><span class="c1"># 4. STANDARD IMQ (Optimizable)</span>
</span><span data-line="370"><span class="c1"># ==============================================================================</span>
</span><span data-line="371">
</span><span data-line="372">
</span><span data-line="373"><span class="nd">@jit</span>
<div class="viewcode-block" id="_imq_kernel_matrix">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces._imq_kernel_matrix">[docs]</a>
</span><span data-line="374"><span class="k">def</span><span class="w"> </span><span class="nf">_imq_kernel_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">):</span>
</span><span data-line="375">    <span class="n">d2</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="376">    <span class="n">K</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">d2</span> <span class="o">+</span> <span class="n">epsilon</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span data-line="377">    <span class="k">return</span> <span class="n">K</span></div>

</span><span data-line="378">
</span><span data-line="379">
<div class="viewcode-block" id="negative_mll_imq_std">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.negative_mll_imq_std">[docs]</a>
</span><span data-line="380"><span class="k">def</span><span class="w"> </span><span class="nf">negative_mll_imq_std</span><span class="p">(</span><span class="n">log_params</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span><span data-line="381">    <span class="n">epsilon</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_params</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span data-line="382">    <span class="n">noise_scalar</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_params</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span data-line="383">    <span class="n">K</span> <span class="o">=</span> <span class="n">_imq_kernel_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">)</span>
</span><span data-line="384">    <span class="k">return</span> <span class="n">generic_negative_mll</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">noise_scalar</span><span class="p">)</span></div>

</span><span data-line="385">
</span><span data-line="386">
</span><span data-line="387"><span class="nd">@jit</span>
<div class="viewcode-block" id="_imq_solve">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces._imq_solve">[docs]</a>
</span><span data-line="388"><span class="k">def</span><span class="w"> </span><span class="nf">_imq_solve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">):</span>
</span><span data-line="389">    <span class="n">K</span> <span class="o">=</span> <span class="n">_imq_kernel_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">)</span>
</span><span data-line="390">    <span class="n">K</span> <span class="o">=</span> <span class="n">K</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">sm</span>
</span><span data-line="391">    <span class="n">L</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
</span><span data-line="392">    <span class="n">alpha</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
</span><span data-line="393">    <span class="k">return</span> <span class="n">alpha</span></div>

</span><span data-line="394">
</span><span data-line="395">
</span><span data-line="396"><span class="nd">@jit</span>
<div class="viewcode-block" id="_imq_predict">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces._imq_predict">[docs]</a>
</span><span data-line="397"><span class="k">def</span><span class="w"> </span><span class="nf">_imq_predict</span><span class="p">(</span><span class="n">x_query</span><span class="p">,</span> <span class="n">x_obs</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">):</span>
</span><span data-line="398">    <span class="n">d2</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x_query</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">x_obs</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="399">    <span class="n">K_q</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">d2</span> <span class="o">+</span> <span class="n">epsilon</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span data-line="400">    <span class="k">return</span> <span class="n">K_q</span> <span class="o">@</span> <span class="n">alpha</span></div>

</span><span data-line="401">
</span><span data-line="402">
<div class="viewcode-block" id="FastIMQ">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.FastIMQ">[docs]</a>
</span><span data-line="403"><span class="k">class</span><span class="w"> </span><span class="nc">FastIMQ</span><span class="p">:</span>
</span><span data-line="404">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span data-line="405">        <span class="bp">self</span><span class="p">,</span> <span class="n">x_obs</span><span class="p">,</span> <span class="n">y_obs</span><span class="p">,</span> <span class="n">smoothing</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">length_scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
</span><span data-line="406">    <span class="p">):</span>
<div class="viewcode-block" id="FastIMQ.x_obs">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.FastIMQ.x_obs">[docs]</a>
</span><span data-line="407">        <span class="bp">self</span><span class="o">.</span><span class="n">x_obs</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x_obs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span></div>

<div class="viewcode-block" id="FastIMQ.y_obs">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.FastIMQ.y_obs">[docs]</a>
</span><span data-line="408">        <span class="bp">self</span><span class="o">.</span><span class="n">y_obs</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_obs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span></div>

<div class="viewcode-block" id="FastIMQ.y_mean">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.FastIMQ.y_mean">[docs]</a>
</span><span data-line="409">        <span class="bp">self</span><span class="o">.</span><span class="n">y_mean</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_obs</span><span class="p">)</span></div>

</span><span data-line="410">        <span class="n">y_centered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_obs</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_mean</span>
</span><span data-line="411">
</span><span data-line="412">        <span class="k">if</span> <span class="n">length_scale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="413">            <span class="n">span</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_obs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">jnp</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_obs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span data-line="414">            <span class="n">init_eps</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">span</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.8</span>
</span><span data-line="415">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="416">            <span class="n">init_eps</span> <span class="o">=</span> <span class="n">length_scale</span>
</span><span data-line="417">        <span class="n">init_noise</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">smoothing</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">)</span>
</span><span data-line="418">
</span><span data-line="419">        <span class="k">if</span> <span class="n">optimize</span><span class="p">:</span>
</span><span data-line="420">            <span class="n">x0</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">init_eps</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">init_noise</span><span class="p">)])</span>
</span><span data-line="421">
</span><span data-line="422">            <span class="k">def</span><span class="w"> </span><span class="nf">loss_fn</span><span class="p">(</span><span class="n">log_p</span><span class="p">):</span>
</span><span data-line="423">                <span class="k">return</span> <span class="n">negative_mll_imq_std</span><span class="p">(</span><span class="n">log_p</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_obs</span><span class="p">,</span> <span class="n">y_centered</span><span class="p">)</span>
</span><span data-line="424">
</span><span data-line="425">            <span class="n">results</span> <span class="o">=</span> <span class="n">jopt</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">loss_fn</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;BFGS&quot;</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
</span><span data-line="426">            <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span data-line="427">            <span class="bp">self</span><span class="o">.</span><span class="n">noise</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</span><span data-line="428">            <span class="k">if</span> <span class="n">jnp</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span><span class="p">)</span> <span class="ow">or</span> <span class="n">jnp</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="p">):</span>
</span><span data-line="429">                <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span> <span class="o">=</span> <span class="n">init_eps</span><span class="p">,</span> <span class="n">init_noise</span>
</span><span data-line="430">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="431">            <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span> <span class="o">=</span> <span class="n">init_eps</span><span class="p">,</span> <span class="n">init_noise</span>
</span><span data-line="432">
<div class="viewcode-block" id="FastIMQ.alpha">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.FastIMQ.alpha">[docs]</a>
</span><span data-line="433">        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">_imq_solve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_obs</span><span class="p">,</span> <span class="n">y_centered</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span><span class="p">)</span></div>

</span><span data-line="434">
<div class="viewcode-block" id="FastIMQ.__call__">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.FastIMQ.__call__">[docs]</a>
</span><span data-line="435">    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_query</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
</span><span data-line="436">        <span class="n">x_query</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x_query</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span data-line="437">        <span class="n">preds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="438">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x_query</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">chunk_size</span><span class="p">):</span>
</span><span data-line="439">            <span class="n">chunk</span> <span class="o">=</span> <span class="n">x_query</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">chunk_size</span><span class="p">]</span>
</span><span data-line="440">            <span class="n">preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_imq_predict</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_obs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span><span class="p">))</span>
</span><span data-line="441">        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_mean</span></div>
</div>

</span><span data-line="442">
</span><span data-line="443">
</span><span data-line="444"><span class="c1"># ==============================================================================</span>
</span><span data-line="445"><span class="c1"># 6. SQUARED EXPONENTIAL (SE) - &quot;The Classic&quot;</span>
</span><span data-line="446"><span class="c1">#    k(r) = exp(-r^2 / (2 * l^2))</span>
</span><span data-line="447"><span class="c1"># ==============================================================================</span>
</span><span data-line="448">
</span><span data-line="449">
<div class="viewcode-block" id="se_kernel_elem">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.se_kernel_elem">[docs]</a>
</span><span data-line="450"><span class="k">def</span><span class="w"> </span><span class="nf">se_kernel_elem</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">length_scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
</span><span data-line="451">    <span class="n">d2</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
</span><span data-line="452">    <span class="c1"># Clamp length_scale to avoid division by zero</span>
</span><span data-line="453">    <span class="n">ls</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">length_scale</span><span class="p">,</span> <span class="mf">1e-5</span><span class="p">)</span>
</span><span data-line="454">    <span class="n">val</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">d2</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">ls</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
</span><span data-line="455">    <span class="k">return</span> <span class="n">val</span></div>

</span><span data-line="456">
</span><span data-line="457">
</span><span data-line="458"><span class="c1"># Auto-diff covariance block</span>
<div class="viewcode-block" id="full_covariance_se">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.full_covariance_se">[docs]</a>
</span><span data-line="459"><span class="k">def</span><span class="w"> </span><span class="nf">full_covariance_se</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">length_scale</span><span class="p">):</span>
</span><span data-line="460">    <span class="n">k_ee</span> <span class="o">=</span> <span class="n">se_kernel_elem</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">length_scale</span><span class="p">)</span>
</span><span data-line="461">    <span class="n">k_ed</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">se_kernel_elem</span><span class="p">,</span> <span class="n">argnums</span><span class="o">=</span><span class="mi">1</span><span class="p">)(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">length_scale</span><span class="p">)</span>
</span><span data-line="462">    <span class="n">k_de</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">se_kernel_elem</span><span class="p">,</span> <span class="n">argnums</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">length_scale</span><span class="p">)</span>
</span><span data-line="463">    <span class="n">k_dd</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">jacfwd</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">se_kernel_elem</span><span class="p">,</span> <span class="n">argnums</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">argnums</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span>
</span><span data-line="464">        <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">length_scale</span>
</span><span data-line="465">    <span class="p">)</span>
</span><span data-line="466">
</span><span data-line="467">    <span class="n">row1</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">k_ee</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="n">k_ed</span><span class="p">])</span>
</span><span data-line="468">    <span class="n">row2</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">k_de</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">k_dd</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="469">    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">row1</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">row2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>

</span><span data-line="470">
</span><span data-line="471">
</span><span data-line="472"><span class="c1"># Vectorize</span>
<div class="viewcode-block" id="k_matrix_se_grad_map">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.k_matrix_se_grad_map">[docs]</a>
</span><span data-line="473"><span class="n">k_matrix_se_grad_map</span> <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="n">vmap</span><span class="p">(</span><span class="n">full_covariance_se</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span></div>

</span><span data-line="474">
</span><span data-line="475">
<div class="viewcode-block" id="negative_mll_se_grad">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.negative_mll_se_grad">[docs]</a>
</span><span data-line="476"><span class="k">def</span><span class="w"> </span><span class="nf">negative_mll_se_grad</span><span class="p">(</span><span class="n">log_params</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y_flat</span><span class="p">,</span> <span class="n">D_plus_1</span><span class="p">):</span>
</span><span data-line="477">    <span class="n">length_scale</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_params</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span data-line="478">    <span class="n">noise_scalar</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_params</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span data-line="479">
</span><span data-line="480">    <span class="n">K_blocks</span> <span class="o">=</span> <span class="n">k_matrix_se_grad_map</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">length_scale</span><span class="p">)</span>
</span><span data-line="481">    <span class="n">N</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span data-line="482">    <span class="n">K_full</span> <span class="o">=</span> <span class="n">K_blocks</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="n">D_plus_1</span><span class="p">,</span> <span class="n">N</span> <span class="o">*</span> <span class="n">D_plus_1</span><span class="p">)</span>
</span><span data-line="483">    <span class="k">return</span> <span class="n">generic_negative_mll</span><span class="p">(</span><span class="n">K_full</span><span class="p">,</span> <span class="n">y_flat</span><span class="p">,</span> <span class="n">noise_scalar</span><span class="p">)</span></div>

</span><span data-line="484">
</span><span data-line="485">
</span><span data-line="486"><span class="nd">@jit</span>
<div class="viewcode-block" id="_grad_se_solve">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces._grad_se_solve">[docs]</a>
</span><span data-line="487"><span class="k">def</span><span class="w"> </span><span class="nf">_grad_se_solve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y_full</span><span class="p">,</span> <span class="n">noise_scalar</span><span class="p">,</span> <span class="n">length_scale</span><span class="p">):</span>
</span><span data-line="488">    <span class="n">K_blocks</span> <span class="o">=</span> <span class="n">k_matrix_se_grad_map</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">length_scale</span><span class="p">)</span>
</span><span data-line="489">    <span class="n">N</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">D_plus_1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">K_blocks</span><span class="o">.</span><span class="n">shape</span>
</span><span data-line="490">    <span class="n">K_full</span> <span class="o">=</span> <span class="n">K_blocks</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="n">D_plus_1</span><span class="p">,</span> <span class="n">N</span> <span class="o">*</span> <span class="n">D_plus_1</span><span class="p">)</span>
</span><span data-line="491">
</span><span data-line="492">    <span class="n">diag_noise</span> <span class="o">=</span> <span class="p">(</span><span class="n">noise_scalar</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="n">D_plus_1</span><span class="p">)</span>
</span><span data-line="493">    <span class="n">K_full</span> <span class="o">=</span> <span class="n">K_full</span> <span class="o">+</span> <span class="n">diag_noise</span>
</span><span data-line="494">
</span><span data-line="495">    <span class="n">alpha</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">K_full</span><span class="p">,</span> <span class="n">y_full</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
</span><span data-line="496">    <span class="k">return</span> <span class="n">alpha</span></div>

</span><span data-line="497">
</span><span data-line="498">
</span><span data-line="499"><span class="nd">@jit</span>
<div class="viewcode-block" id="_grad_se_predict">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces._grad_se_predict">[docs]</a>
</span><span data-line="500"><span class="k">def</span><span class="w"> </span><span class="nf">_grad_se_predict</span><span class="p">(</span><span class="n">x_query</span><span class="p">,</span> <span class="n">x_obs</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">length_scale</span><span class="p">):</span>
</span><span data-line="501">    <span class="k">def</span><span class="w"> </span><span class="nf">get_query_row</span><span class="p">(</span><span class="n">xq</span><span class="p">,</span> <span class="n">xo</span><span class="p">):</span>
</span><span data-line="502">        <span class="n">kee</span> <span class="o">=</span> <span class="n">se_kernel_elem</span><span class="p">(</span><span class="n">xq</span><span class="p">,</span> <span class="n">xo</span><span class="p">,</span> <span class="n">length_scale</span><span class="p">)</span>
</span><span data-line="503">        <span class="n">ked</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">se_kernel_elem</span><span class="p">,</span> <span class="n">argnums</span><span class="o">=</span><span class="mi">1</span><span class="p">)(</span><span class="n">xq</span><span class="p">,</span> <span class="n">xo</span><span class="p">,</span> <span class="n">length_scale</span><span class="p">)</span>
</span><span data-line="504">        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">kee</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="n">ked</span><span class="p">])</span>
</span><span data-line="505">
</span><span data-line="506">    <span class="n">K_q</span> <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="n">vmap</span><span class="p">(</span><span class="n">get_query_row</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">))(</span><span class="n">x_query</span><span class="p">,</span> <span class="n">x_obs</span><span class="p">)</span>
</span><span data-line="507">    <span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">D_plus_1</span> <span class="o">=</span> <span class="n">K_q</span><span class="o">.</span><span class="n">shape</span>
</span><span data-line="508">    <span class="k">return</span> <span class="n">K_q</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">N</span> <span class="o">*</span> <span class="n">D_plus_1</span><span class="p">)</span> <span class="o">@</span> <span class="n">alpha</span></div>

</span><span data-line="509">
</span><span data-line="510">
<div class="viewcode-block" id="GradientSE">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.GradientSE">[docs]</a>
</span><span data-line="511"><span class="k">class</span><span class="w"> </span><span class="nc">GradientSE</span><span class="p">:</span>
</span><span data-line="512">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span data-line="513">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="514">        <span class="n">x</span><span class="p">,</span>
</span><span data-line="515">        <span class="n">y</span><span class="p">,</span>
</span><span data-line="516">        <span class="n">gradients</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span data-line="517">        <span class="n">smoothing</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>
</span><span data-line="518">        <span class="n">length_scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span data-line="519">        <span class="n">optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="520">        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span data-line="521">    <span class="p">):</span>
<div class="viewcode-block" id="GradientSE.x">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.GradientSE.x">[docs]</a>
</span><span data-line="522">        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span></div>

</span><span data-line="523">        <span class="n">y_energies</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span>
</span><span data-line="524">        <span class="n">grad_vals</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="525">            <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">gradients</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span data-line="526">            <span class="k">if</span> <span class="n">gradients</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="527">            <span class="k">else</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
</span><span data-line="528">        <span class="p">)</span>
</span><span data-line="529">
<div class="viewcode-block" id="GradientSE.y_full">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.GradientSE.y_full">[docs]</a>
</span><span data-line="530">        <span class="bp">self</span><span class="o">.</span><span class="n">y_full</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">y_energies</span><span class="p">,</span> <span class="n">grad_vals</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="GradientSE.e_mean">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.GradientSE.e_mean">[docs]</a>
</span><span data-line="531">        <span class="bp">self</span><span class="o">.</span><span class="n">e_mean</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_energies</span><span class="p">)</span></div>

</span><span data-line="532">        <span class="bp">self</span><span class="o">.</span><span class="n">y_full</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_full</span><span class="o">.</span><span class="n">at</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">e_mean</span><span class="p">)</span>
<div class="viewcode-block" id="GradientSE.y_flat">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.GradientSE.y_flat">[docs]</a>
</span><span data-line="533">        <span class="bp">self</span><span class="o">.</span><span class="n">y_flat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_full</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span></div>

</span><span data-line="534">        <span class="n">D_plus_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
</span><span data-line="535">
</span><span data-line="536">        <span class="k">if</span> <span class="n">length_scale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="537">            <span class="n">span</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">jnp</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span data-line="538">            <span class="n">init_ls</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">span</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.4</span>
</span><span data-line="539">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="540">            <span class="n">init_ls</span> <span class="o">=</span> <span class="n">length_scale</span>
</span><span data-line="541">        <span class="n">init_noise</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">smoothing</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">)</span>
</span><span data-line="542">
</span><span data-line="543">        <span class="k">if</span> <span class="n">optimize</span><span class="p">:</span>
</span><span data-line="544">            <span class="n">x0</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">init_ls</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">init_noise</span><span class="p">)])</span>
</span><span data-line="545">
</span><span data-line="546">            <span class="k">def</span><span class="w"> </span><span class="nf">loss_fn</span><span class="p">(</span><span class="n">log_p</span><span class="p">):</span>
</span><span data-line="547">                <span class="k">return</span> <span class="n">negative_mll_se_grad</span><span class="p">(</span><span class="n">log_p</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_flat</span><span class="p">,</span> <span class="n">D_plus_1</span><span class="p">)</span>
</span><span data-line="548">
</span><span data-line="549">            <span class="n">results</span> <span class="o">=</span> <span class="n">jopt</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">loss_fn</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;BFGS&quot;</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
</span><span data-line="550">            <span class="bp">self</span><span class="o">.</span><span class="n">ls</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span data-line="551">            <span class="bp">self</span><span class="o">.</span><span class="n">noise</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</span><span data-line="552">            <span class="k">if</span> <span class="n">jnp</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ls</span><span class="p">)</span> <span class="ow">or</span> <span class="n">jnp</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="p">):</span>
</span><span data-line="553">                <span class="bp">self</span><span class="o">.</span><span class="n">ls</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span> <span class="o">=</span> <span class="n">init_ls</span><span class="p">,</span> <span class="n">init_noise</span>
</span><span data-line="554">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="555">            <span class="bp">self</span><span class="o">.</span><span class="n">ls</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span> <span class="o">=</span> <span class="n">init_ls</span><span class="p">,</span> <span class="n">init_noise</span>
</span><span data-line="556">
<div class="viewcode-block" id="GradientSE.alpha">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.GradientSE.alpha">[docs]</a>
</span><span data-line="557">        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">_grad_se_solve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_full</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ls</span><span class="p">)</span></div>

</span><span data-line="558">
<div class="viewcode-block" id="GradientSE.__call__">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.GradientSE.__call__">[docs]</a>
</span><span data-line="559">    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_query</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
</span><span data-line="560">        <span class="n">x_query</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x_query</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span data-line="561">        <span class="n">preds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="562">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x_query</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">chunk_size</span><span class="p">):</span>
</span><span data-line="563">            <span class="n">chunk</span> <span class="o">=</span> <span class="n">x_query</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">chunk_size</span><span class="p">]</span>
</span><span data-line="564">            <span class="n">preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_grad_se_predict</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ls</span><span class="p">))</span>
</span><span data-line="565">        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_mean</span></div>
</div>

</span><span data-line="566">
</span><span data-line="567">
</span><span data-line="568"><span class="c1"># ==============================================================================</span>
</span><span data-line="569"><span class="c1"># 5. GRADIENT-ENHANCED IMQ (Optimizable)</span>
</span><span data-line="570"><span class="c1"># ==============================================================================</span>
</span><span data-line="571">
</span><span data-line="572">
<div class="viewcode-block" id="imq_kernel_elem">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.imq_kernel_elem">[docs]</a>
</span><span data-line="573"><span class="k">def</span><span class="w"> </span><span class="nf">imq_kernel_elem</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
</span><span data-line="574">    <span class="n">d2</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
</span><span data-line="575">    <span class="n">val</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">d2</span> <span class="o">+</span> <span class="n">epsilon</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span data-line="576">    <span class="k">return</span> <span class="n">val</span></div>

</span><span data-line="577">
</span><span data-line="578">
<div class="viewcode-block" id="full_covariance_imq">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.full_covariance_imq">[docs]</a>
</span><span data-line="579"><span class="k">def</span><span class="w"> </span><span class="nf">full_covariance_imq</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">):</span>
</span><span data-line="580">    <span class="n">k_ee</span> <span class="o">=</span> <span class="n">imq_kernel_elem</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">)</span>
</span><span data-line="581">    <span class="n">k_ed</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">imq_kernel_elem</span><span class="p">,</span> <span class="n">argnums</span><span class="o">=</span><span class="mi">1</span><span class="p">)(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">)</span>
</span><span data-line="582">    <span class="n">k_de</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">imq_kernel_elem</span><span class="p">,</span> <span class="n">argnums</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">)</span>
</span><span data-line="583">    <span class="n">k_dd</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">jacfwd</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">imq_kernel_elem</span><span class="p">,</span> <span class="n">argnums</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">argnums</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">)</span>
</span><span data-line="584">    <span class="n">row1</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">k_ee</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="n">k_ed</span><span class="p">])</span>
</span><span data-line="585">    <span class="n">row2</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">k_de</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">k_dd</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="586">    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">row1</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">row2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>

</span><span data-line="587">
</span><span data-line="588">
<div class="viewcode-block" id="k_matrix_imq_grad_map">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.k_matrix_imq_grad_map">[docs]</a>
</span><span data-line="589"><span class="n">k_matrix_imq_grad_map</span> <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span>
</span><span data-line="590">    <span class="n">vmap</span><span class="p">(</span><span class="n">full_covariance_imq</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span data-line="591"><span class="p">)</span></div>

</span><span data-line="592">
</span><span data-line="593">
<div class="viewcode-block" id="negative_mll_imq_grad">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.negative_mll_imq_grad">[docs]</a>
</span><span data-line="594"><span class="k">def</span><span class="w"> </span><span class="nf">negative_mll_imq_grad</span><span class="p">(</span><span class="n">log_params</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y_flat</span><span class="p">,</span> <span class="n">D_plus_1</span><span class="p">):</span>
</span><span data-line="595">    <span class="n">epsilon</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_params</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span data-line="596">    <span class="n">noise_scalar</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_params</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span data-line="597">    <span class="n">K_blocks</span> <span class="o">=</span> <span class="n">k_matrix_imq_grad_map</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">)</span>
</span><span data-line="598">    <span class="n">N</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span data-line="599">    <span class="n">K_full</span> <span class="o">=</span> <span class="n">K_blocks</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="n">D_plus_1</span><span class="p">,</span> <span class="n">N</span> <span class="o">*</span> <span class="n">D_plus_1</span><span class="p">)</span>
</span><span data-line="600">    <span class="k">return</span> <span class="n">generic_negative_mll</span><span class="p">(</span><span class="n">K_full</span><span class="p">,</span> <span class="n">y_flat</span><span class="p">,</span> <span class="n">noise_scalar</span><span class="p">)</span></div>

</span><span data-line="601">
<div class="viewcode-block" id="negative_mll_imq_map">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.negative_mll_imq_map">[docs]</a>
</span><span data-line="602"><span class="k">def</span><span class="w"> </span><span class="nf">negative_mll_imq_map</span><span class="p">(</span><span class="n">log_params</span><span class="p">,</span> <span class="n">init_eps</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y_flat</span><span class="p">,</span> <span class="n">D_plus_1</span><span class="p">):</span>
</span><span data-line="603">    <span class="n">log_eps</span> <span class="o">=</span> <span class="n">log_params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span data-line="604">    <span class="n">log_noise</span> <span class="o">=</span> <span class="n">log_params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span data-line="605">
</span><span data-line="606">    <span class="n">epsilon</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_eps</span><span class="p">)</span>
</span><span data-line="607">    <span class="n">noise_scalar</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_noise</span><span class="p">)</span>
</span><span data-line="608">
</span><span data-line="609">    <span class="c1"># Likelihood (Data Fit)</span>
</span><span data-line="610">    <span class="n">K_blocks</span> <span class="o">=</span> <span class="n">k_matrix_imq_grad_map</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">)</span>
</span><span data-line="611">    <span class="n">N</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span data-line="612">    <span class="n">K_full</span> <span class="o">=</span> <span class="n">K_blocks</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="n">D_plus_1</span><span class="p">,</span> <span class="n">N</span> <span class="o">*</span> <span class="n">D_plus_1</span><span class="p">)</span>
</span><span data-line="613">    <span class="n">mll_cost</span> <span class="o">=</span> <span class="n">generic_negative_mll</span><span class="p">(</span><span class="n">K_full</span><span class="p">,</span> <span class="n">y_flat</span><span class="p">,</span> <span class="n">noise_scalar</span><span class="p">)</span>
</span><span data-line="614">
</span><span data-line="615">    <span class="c1"># --- Gamma Prior on Epsilon ---</span>
</span><span data-line="616">    <span class="c1"># Distribution should peak at &#39;init_eps&#39; but kills large values.</span>
</span><span data-line="617">    <span class="c1"># Gamma PDF: x^(alpha-1) * exp(-beta * x)</span>
</span><span data-line="618">    <span class="c1"># NegLogPDF: -(alpha-1)*log(x) + beta*x</span>
</span><span data-line="619">
</span><span data-line="620">    <span class="n">alpha_g</span> <span class="o">=</span> <span class="mf">2.0</span>  <span class="c1"># Shape=2 ensures the distribution goes to 0 at epsilon=0 (physical)</span>
</span><span data-line="621">    <span class="n">beta_g</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">init_eps</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span> <span class="c1"># Rate set so the peak (mode) is roughly at init_eps</span>
</span><span data-line="622">
</span><span data-line="623">    <span class="c1"># This linear &#39;epsilon&#39; term is what stops it from shooting up</span>
</span><span data-line="624">    <span class="n">eps_penalty</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">alpha_g</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">log_eps</span> <span class="o">+</span> <span class="n">beta_g</span> <span class="o">*</span> <span class="n">epsilon</span>
</span><span data-line="625">
</span><span data-line="626">    <span class="c1"># --- Log-Normal Prior on Noise ---</span>
</span><span data-line="627">    <span class="c1"># Log-Normal is fine for noise; to stay in a magnitude range</span>
</span><span data-line="628">    <span class="n">noise_target</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1e-2</span><span class="p">)</span>
</span><span data-line="629">    <span class="n">noise_penalty</span> <span class="o">=</span> <span class="p">(</span><span class="n">log_noise</span> <span class="o">-</span> <span class="n">noise_target</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="mf">0.5</span>
</span><span data-line="630">
</span><span data-line="631">    <span class="k">return</span> <span class="n">mll_cost</span> <span class="o">+</span> <span class="n">eps_penalty</span> <span class="o">+</span> <span class="n">noise_penalty</span></div>

</span><span data-line="632">
</span><span data-line="633"><span class="nd">@jit</span>
<div class="viewcode-block" id="_grad_imq_solve">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces._grad_imq_solve">[docs]</a>
</span><span data-line="634"><span class="k">def</span><span class="w"> </span><span class="nf">_grad_imq_solve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y_full</span><span class="p">,</span> <span class="n">noise_scalar</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">):</span>
</span><span data-line="635">    <span class="n">K_blocks</span> <span class="o">=</span> <span class="n">k_matrix_imq_grad_map</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">)</span>
</span><span data-line="636">    <span class="n">N</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">D_plus_1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">K_blocks</span><span class="o">.</span><span class="n">shape</span>
</span><span data-line="637">    <span class="n">K_full</span> <span class="o">=</span> <span class="n">K_blocks</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="n">D_plus_1</span><span class="p">,</span> <span class="n">N</span> <span class="o">*</span> <span class="n">D_plus_1</span><span class="p">)</span>
</span><span data-line="638">    <span class="n">diag_noise</span> <span class="o">=</span> <span class="p">(</span><span class="n">noise_scalar</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="n">D_plus_1</span><span class="p">)</span>
</span><span data-line="639">    <span class="n">K_full</span> <span class="o">=</span> <span class="n">K_full</span> <span class="o">+</span> <span class="n">diag_noise</span>
</span><span data-line="640">    <span class="n">alpha</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">K_full</span><span class="p">,</span> <span class="n">y_full</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
</span><span data-line="641">    <span class="k">return</span> <span class="n">alpha</span></div>

</span><span data-line="642">
</span><span data-line="643">
</span><span data-line="644"><span class="nd">@jit</span>
<div class="viewcode-block" id="_grad_imq_predict">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces._grad_imq_predict">[docs]</a>
</span><span data-line="645"><span class="k">def</span><span class="w"> </span><span class="nf">_grad_imq_predict</span><span class="p">(</span><span class="n">x_query</span><span class="p">,</span> <span class="n">x_obs</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">):</span>
</span><span data-line="646">    <span class="k">def</span><span class="w"> </span><span class="nf">get_query_row</span><span class="p">(</span><span class="n">xq</span><span class="p">,</span> <span class="n">xo</span><span class="p">):</span>
</span><span data-line="647">        <span class="n">kee</span> <span class="o">=</span> <span class="n">imq_kernel_elem</span><span class="p">(</span><span class="n">xq</span><span class="p">,</span> <span class="n">xo</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">)</span>
</span><span data-line="648">        <span class="n">ked</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">imq_kernel_elem</span><span class="p">,</span> <span class="n">argnums</span><span class="o">=</span><span class="mi">1</span><span class="p">)(</span><span class="n">xq</span><span class="p">,</span> <span class="n">xo</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">)</span>
</span><span data-line="649">        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">kee</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="n">ked</span><span class="p">])</span>
</span><span data-line="650">
</span><span data-line="651">    <span class="n">K_q</span> <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="n">vmap</span><span class="p">(</span><span class="n">get_query_row</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">))(</span><span class="n">x_query</span><span class="p">,</span> <span class="n">x_obs</span><span class="p">)</span>
</span><span data-line="652">    <span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">D_plus_1</span> <span class="o">=</span> <span class="n">K_q</span><span class="o">.</span><span class="n">shape</span>
</span><span data-line="653">    <span class="k">return</span> <span class="n">K_q</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">N</span> <span class="o">*</span> <span class="n">D_plus_1</span><span class="p">)</span> <span class="o">@</span> <span class="n">alpha</span></div>

</span><span data-line="654">
</span><span data-line="655">
<div class="viewcode-block" id="GradientIMQ">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.GradientIMQ">[docs]</a>
</span><span data-line="656"><span class="k">class</span><span class="w"> </span><span class="nc">GradientIMQ</span><span class="p">:</span>
</span><span data-line="657">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span data-line="658">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="659">        <span class="n">x</span><span class="p">,</span>
</span><span data-line="660">        <span class="n">y</span><span class="p">,</span>
</span><span data-line="661">        <span class="n">gradients</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span data-line="662">        <span class="n">smoothing</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>
</span><span data-line="663">        <span class="n">length_scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span data-line="664">        <span class="n">optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="665">        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span data-line="666">    <span class="p">):</span>
<div class="viewcode-block" id="GradientIMQ.x">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.GradientIMQ.x">[docs]</a>
</span><span data-line="667">        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span></div>

</span><span data-line="668">        <span class="n">y_energies</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span>
</span><span data-line="669">        <span class="n">grad_vals</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="670">            <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">gradients</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span data-line="671">            <span class="k">if</span> <span class="n">gradients</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="672">            <span class="k">else</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
</span><span data-line="673">        <span class="p">)</span>
</span><span data-line="674">
<div class="viewcode-block" id="GradientIMQ.y_full">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.GradientIMQ.y_full">[docs]</a>
</span><span data-line="675">        <span class="bp">self</span><span class="o">.</span><span class="n">y_full</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">y_energies</span><span class="p">,</span> <span class="n">grad_vals</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="GradientIMQ.e_mean">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.GradientIMQ.e_mean">[docs]</a>
</span><span data-line="676">        <span class="bp">self</span><span class="o">.</span><span class="n">e_mean</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_energies</span><span class="p">)</span></div>

</span><span data-line="677">        <span class="bp">self</span><span class="o">.</span><span class="n">y_full</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_full</span><span class="o">.</span><span class="n">at</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">e_mean</span><span class="p">)</span>
<div class="viewcode-block" id="GradientIMQ.y_flat">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.GradientIMQ.y_flat">[docs]</a>
</span><span data-line="678">        <span class="bp">self</span><span class="o">.</span><span class="n">y_flat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_full</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span></div>

</span><span data-line="679">        <span class="n">D_plus_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
</span><span data-line="680">
</span><span data-line="681">        <span class="k">if</span> <span class="n">length_scale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="682">            <span class="n">span</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">jnp</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span data-line="683">            <span class="n">init_eps</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">span</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.8</span>
</span><span data-line="684">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="685">            <span class="n">init_eps</span> <span class="o">=</span> <span class="n">length_scale</span>
</span><span data-line="686">        <span class="n">init_noise</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">smoothing</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">)</span>
</span><span data-line="687">
</span><span data-line="688">        <span class="k">if</span> <span class="n">optimize</span><span class="p">:</span>
</span><span data-line="689">            <span class="n">x0</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">init_eps</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">init_noise</span><span class="p">)])</span>
</span><span data-line="690">
</span><span data-line="691">            <span class="k">def</span><span class="w"> </span><span class="nf">loss_fn</span><span class="p">(</span><span class="n">log_p</span><span class="p">):</span>
</span><span data-line="692">                <span class="k">return</span> <span class="n">negative_mll_imq_map</span><span class="p">(</span><span class="n">log_p</span><span class="p">,</span> <span class="n">init_eps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_flat</span><span class="p">,</span> <span class="n">D_plus_1</span><span class="p">)</span>
</span><span data-line="693">
</span><span data-line="694">            <span class="n">results</span> <span class="o">=</span> <span class="n">jopt</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">loss_fn</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;BFGS&quot;</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
</span><span data-line="695">            <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span data-line="696">            <span class="bp">self</span><span class="o">.</span><span class="n">noise</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</span><span data-line="697">            <span class="k">if</span> <span class="n">jnp</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span><span class="p">)</span> <span class="ow">or</span> <span class="n">jnp</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="p">):</span>
</span><span data-line="698">                <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span> <span class="o">=</span> <span class="n">init_eps</span><span class="p">,</span> <span class="n">init_noise</span>
</span><span data-line="699">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="700">            <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span> <span class="o">=</span> <span class="n">init_eps</span><span class="p">,</span> <span class="n">init_noise</span>
</span><span data-line="701">
<div class="viewcode-block" id="GradientIMQ.alpha">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.GradientIMQ.alpha">[docs]</a>
</span><span data-line="702">        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">_grad_imq_solve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_full</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span><span class="p">)</span></div>

</span><span data-line="703">
<div class="viewcode-block" id="GradientIMQ.__call__">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.GradientIMQ.__call__">[docs]</a>
</span><span data-line="704">    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_query</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
</span><span data-line="705">        <span class="n">x_query</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x_query</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span data-line="706">        <span class="n">preds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="707">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x_query</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">chunk_size</span><span class="p">):</span>
</span><span data-line="708">            <span class="n">chunk</span> <span class="o">=</span> <span class="n">x_query</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">chunk_size</span><span class="p">]</span>
</span><span data-line="709">            <span class="n">preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_grad_imq_predict</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span><span class="p">))</span>
</span><span data-line="710">        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_mean</span></div>
</div>

</span><span data-line="711">
</span><span data-line="712">
</span><span data-line="713"><span class="c1"># ==============================================================================</span>
</span><span data-line="714"><span class="c1"># 7. RATIONAL QUADRATIC (RQ)</span>
</span><span data-line="715"><span class="c1">#    k(r) = (1 + r^2 / (2 * alpha * l^2))^(-alpha)</span>
</span><span data-line="716"><span class="c1"># ==============================================================================</span>
</span><span data-line="717">
</span><span data-line="718">
<div class="viewcode-block" id="rq_kernel_base">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.rq_kernel_base">[docs]</a>
</span><span data-line="719"><span class="k">def</span><span class="w"> </span><span class="nf">rq_kernel_base</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">length_scale</span><span class="p">,</span> <span class="n">alpha</span><span class="p">):</span>
</span><span data-line="720"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Standard RQ Kernel: (1 + r^2 / (2*alpha*l^2))^-alpha&quot;&quot;&quot;</span>
</span><span data-line="721">    <span class="n">d2</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
</span><span data-line="722">    <span class="n">base</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="n">d2</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span><span class="n">length_scale</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span>
</span><span data-line="723">    <span class="n">val</span> <span class="o">=</span> <span class="n">base</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="n">alpha</span><span class="p">)</span>
</span><span data-line="724">    <span class="k">return</span> <span class="n">val</span></div>

</span><span data-line="725">
</span><span data-line="726">
<div class="viewcode-block" id="rq_kernel_elem">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.rq_kernel_elem">[docs]</a>
</span><span data-line="727"><span class="k">def</span><span class="w"> </span><span class="nf">rq_kernel_elem</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
</span><span data-line="728"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="729"><span class="sd">    SYMMETRIC KERNEL TRICK: k_sym(x, x&#39;) = k(x, x&#39;) + k(swap(x), x&#39;)</span>
</span><span data-line="730"><span class="sd">    Enforces f(r, p) = f(p, r) globally.</span>
</span><span data-line="731"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="732">    <span class="c1"># Params: [length_scale, alpha]</span>
</span><span data-line="733">    <span class="n">length_scale</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span data-line="734">    <span class="n">alpha</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span data-line="735">
</span><span data-line="736">    <span class="c1"># Standard interaction</span>
</span><span data-line="737">    <span class="n">k_direct</span> <span class="o">=</span> <span class="n">rq_kernel_base</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">length_scale</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
</span><span data-line="738">
</span><span data-line="739">    <span class="c1"># Swapped interaction (Mirror across diagonal)</span>
</span><span data-line="740">    <span class="c1"># x1[::-1] swaps (r, p) -&gt; (p, r)</span>
</span><span data-line="741">    <span class="n">k_mirror</span> <span class="o">=</span> <span class="n">rq_kernel_base</span><span class="p">(</span><span class="n">x1</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">x2</span><span class="p">,</span> <span class="n">length_scale</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
</span><span data-line="742">
</span><span data-line="743">    <span class="c1"># Summing them enforces symmetry in the output function</span>
</span><span data-line="744">    <span class="k">return</span> <span class="n">k_direct</span> <span class="o">+</span> <span class="n">k_mirror</span></div>

</span><span data-line="745">
</span><span data-line="746">
</span><span data-line="747"><span class="c1"># Auto-diff covariance block</span>
<div class="viewcode-block" id="full_covariance_rq">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.full_covariance_rq">[docs]</a>
</span><span data-line="748"><span class="k">def</span><span class="w"> </span><span class="nf">full_covariance_rq</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
</span><span data-line="749">    <span class="n">k_ee</span> <span class="o">=</span> <span class="n">rq_kernel_elem</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</span><span data-line="750">    <span class="n">k_ed</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">rq_kernel_elem</span><span class="p">,</span> <span class="n">argnums</span><span class="o">=</span><span class="mi">1</span><span class="p">)(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</span><span data-line="751">    <span class="n">k_de</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">rq_kernel_elem</span><span class="p">,</span> <span class="n">argnums</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</span><span data-line="752">    <span class="n">k_dd</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">jacfwd</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">rq_kernel_elem</span><span class="p">,</span> <span class="n">argnums</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">argnums</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</span><span data-line="753">
</span><span data-line="754">    <span class="n">row1</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">k_ee</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="n">k_ed</span><span class="p">])</span>
</span><span data-line="755">    <span class="n">row2</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">k_de</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">k_dd</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span data-line="756">    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">row1</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">row2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>

</span><span data-line="757">
</span><span data-line="758">
<div class="viewcode-block" id="k_matrix_rq_grad_map">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.k_matrix_rq_grad_map">[docs]</a>
</span><span data-line="759"><span class="n">k_matrix_rq_grad_map</span> <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="n">vmap</span><span class="p">(</span><span class="n">full_covariance_rq</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span></div>

</span><span data-line="760">
</span><span data-line="761">
</span><span data-line="762"><span class="c1"># --- MAXIMUM A POSTERIORI LOSS ---</span>
<div class="viewcode-block" id="negative_mll_rq_map">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.negative_mll_rq_map">[docs]</a>
</span><span data-line="763"><span class="k">def</span><span class="w"> </span><span class="nf">negative_mll_rq_map</span><span class="p">(</span><span class="n">log_params</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y_flat</span><span class="p">,</span> <span class="n">D_plus_1</span><span class="p">):</span>
</span><span data-line="764">    <span class="n">log_ls</span> <span class="o">=</span> <span class="n">log_params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span data-line="765">    <span class="n">log_alpha</span> <span class="o">=</span> <span class="n">log_params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span data-line="766">    <span class="n">log_noise</span> <span class="o">=</span> <span class="n">log_params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span data-line="767">
</span><span data-line="768">    <span class="n">length_scale</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_ls</span><span class="p">)</span>
</span><span data-line="769">    <span class="n">alpha</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_alpha</span><span class="p">)</span>
</span><span data-line="770">    <span class="n">noise_scalar</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_noise</span><span class="p">)</span>
</span><span data-line="771">
</span><span data-line="772">    <span class="c1"># 1. Likelihood (Data Fit)</span>
</span><span data-line="773">    <span class="n">params</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">length_scale</span><span class="p">,</span> <span class="n">alpha</span><span class="p">])</span>
</span><span data-line="774">    <span class="n">K_blocks</span> <span class="o">=</span> <span class="n">k_matrix_rq_grad_map</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</span><span data-line="775">    <span class="n">N</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span data-line="776">    <span class="n">K_full</span> <span class="o">=</span> <span class="n">K_blocks</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="n">D_plus_1</span><span class="p">,</span> <span class="n">N</span> <span class="o">*</span> <span class="n">D_plus_1</span><span class="p">)</span>
</span><span data-line="777">    <span class="n">mll_cost</span> <span class="o">=</span> <span class="n">generic_negative_mll</span><span class="p">(</span><span class="n">K_full</span><span class="p">,</span> <span class="n">y_flat</span><span class="p">,</span> <span class="n">noise_scalar</span><span class="p">)</span>
</span><span data-line="778">
</span><span data-line="779">    <span class="c1"># LS Prior: Target 1.5 √Ö (Forces global connection).</span>
</span><span data-line="780">    <span class="c1"># Variance 0.05 (Very Stiff)</span>
</span><span data-line="781">    <span class="n">ls_target</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.5</span><span class="p">)</span>
</span><span data-line="782">    <span class="n">ls_penalty</span> <span class="o">=</span> <span class="p">(</span><span class="n">log_ls</span> <span class="o">-</span> <span class="n">ls_target</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="mf">0.05</span>
</span><span data-line="783">
</span><span data-line="784">    <span class="c1"># Noise Prior: Target 1e-2 (Relaxes &quot;Exactness&quot;).</span>
</span><span data-line="785">    <span class="c1"># Allows the surface to smooth out gradient conflicts (fixing bubbles).</span>
</span><span data-line="786">    <span class="c1"># Variance 1.0 (Medium) -&gt; Allows some data-driven movement.</span>
</span><span data-line="787">    <span class="n">noise_target</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1e-2</span><span class="p">)</span>
</span><span data-line="788">    <span class="n">noise_penalty</span> <span class="o">=</span> <span class="p">(</span><span class="n">log_noise</span> <span class="o">-</span> <span class="n">noise_target</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="mf">1.0</span>
</span><span data-line="789">
</span><span data-line="790">    <span class="c1"># Alpha Prior: Target 0.8 (Long tails / Global structure).</span>
</span><span data-line="791">    <span class="n">alpha_target</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">0.8</span><span class="p">)</span>
</span><span data-line="792">    <span class="n">alpha_penalty</span> <span class="o">=</span> <span class="p">(</span><span class="n">log_alpha</span> <span class="o">-</span> <span class="n">alpha_target</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="mf">0.5</span>
</span><span data-line="793">
</span><span data-line="794">    <span class="k">return</span> <span class="n">mll_cost</span> <span class="o">+</span> <span class="n">ls_penalty</span> <span class="o">+</span> <span class="n">noise_penalty</span> <span class="o">+</span> <span class="n">alpha_penalty</span></div>

</span><span data-line="795">
</span><span data-line="796">
</span><span data-line="797"><span class="nd">@jit</span>
<div class="viewcode-block" id="_grad_rq_solve">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces._grad_rq_solve">[docs]</a>
</span><span data-line="798"><span class="k">def</span><span class="w"> </span><span class="nf">_grad_rq_solve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y_full</span><span class="p">,</span> <span class="n">noise_scalar</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
</span><span data-line="799">    <span class="n">K_blocks</span> <span class="o">=</span> <span class="n">k_matrix_rq_grad_map</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</span><span data-line="800">    <span class="n">N</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">D_plus_1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">K_blocks</span><span class="o">.</span><span class="n">shape</span>
</span><span data-line="801">    <span class="n">K_full</span> <span class="o">=</span> <span class="n">K_blocks</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="n">D_plus_1</span><span class="p">,</span> <span class="n">N</span> <span class="o">*</span> <span class="n">D_plus_1</span><span class="p">)</span>
</span><span data-line="802">
</span><span data-line="803">    <span class="n">diag_noise</span> <span class="o">=</span> <span class="p">(</span><span class="n">noise_scalar</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="n">D_plus_1</span><span class="p">)</span>
</span><span data-line="804">    <span class="n">K_full</span> <span class="o">=</span> <span class="n">K_full</span> <span class="o">+</span> <span class="n">diag_noise</span>
</span><span data-line="805">
</span><span data-line="806">    <span class="n">alpha</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">K_full</span><span class="p">,</span> <span class="n">y_full</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
</span><span data-line="807">    <span class="k">return</span> <span class="n">alpha</span></div>

</span><span data-line="808">
</span><span data-line="809">
</span><span data-line="810"><span class="nd">@jit</span>
<div class="viewcode-block" id="_grad_rq_predict">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces._grad_rq_predict">[docs]</a>
</span><span data-line="811"><span class="k">def</span><span class="w"> </span><span class="nf">_grad_rq_predict</span><span class="p">(</span><span class="n">x_query</span><span class="p">,</span> <span class="n">x_obs</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
</span><span data-line="812">    <span class="k">def</span><span class="w"> </span><span class="nf">get_query_row</span><span class="p">(</span><span class="n">xq</span><span class="p">,</span> <span class="n">xo</span><span class="p">):</span>
</span><span data-line="813">        <span class="n">kee</span> <span class="o">=</span> <span class="n">rq_kernel_elem</span><span class="p">(</span><span class="n">xq</span><span class="p">,</span> <span class="n">xo</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</span><span data-line="814">        <span class="n">ked</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">rq_kernel_elem</span><span class="p">,</span> <span class="n">argnums</span><span class="o">=</span><span class="mi">1</span><span class="p">)(</span><span class="n">xq</span><span class="p">,</span> <span class="n">xo</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</span><span data-line="815">        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">kee</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="n">ked</span><span class="p">])</span>
</span><span data-line="816">
</span><span data-line="817">    <span class="n">K_q</span> <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="n">vmap</span><span class="p">(</span><span class="n">get_query_row</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">))(</span><span class="n">x_query</span><span class="p">,</span> <span class="n">x_obs</span><span class="p">)</span>
</span><span data-line="818">    <span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">D_plus_1</span> <span class="o">=</span> <span class="n">K_q</span><span class="o">.</span><span class="n">shape</span>
</span><span data-line="819">    <span class="k">return</span> <span class="n">K_q</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">N</span> <span class="o">*</span> <span class="n">D_plus_1</span><span class="p">)</span> <span class="o">@</span> <span class="n">alpha</span></div>

</span><span data-line="820">
</span><span data-line="821">
<div class="viewcode-block" id="GradientRQ">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.GradientRQ">[docs]</a>
</span><span data-line="822"><span class="k">class</span><span class="w"> </span><span class="nc">GradientRQ</span><span class="p">:</span>
</span><span data-line="823">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span data-line="824">        <span class="bp">self</span><span class="p">,</span>
</span><span data-line="825">        <span class="n">x</span><span class="p">,</span>
</span><span data-line="826">        <span class="n">y</span><span class="p">,</span>
</span><span data-line="827">        <span class="n">gradients</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span data-line="828">        <span class="n">smoothing</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>
</span><span data-line="829">        <span class="n">length_scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span data-line="830">        <span class="n">optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span data-line="831">        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span data-line="832">    <span class="p">):</span>
<div class="viewcode-block" id="GradientRQ.x">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.GradientRQ.x">[docs]</a>
</span><span data-line="833">        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span></div>

</span><span data-line="834">        <span class="n">y_energies</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span>
</span><span data-line="835">        <span class="n">grad_vals</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="836">            <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">gradients</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span data-line="837">            <span class="k">if</span> <span class="n">gradients</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span data-line="838">            <span class="k">else</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
</span><span data-line="839">        <span class="p">)</span>
</span><span data-line="840">
<div class="viewcode-block" id="GradientRQ.y_full">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.GradientRQ.y_full">[docs]</a>
</span><span data-line="841">        <span class="bp">self</span><span class="o">.</span><span class="n">y_full</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">y_energies</span><span class="p">,</span> <span class="n">grad_vals</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="GradientRQ.e_mean">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.GradientRQ.e_mean">[docs]</a>
</span><span data-line="842">        <span class="bp">self</span><span class="o">.</span><span class="n">e_mean</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_energies</span><span class="p">)</span></div>

</span><span data-line="843">        <span class="bp">self</span><span class="o">.</span><span class="n">y_full</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_full</span><span class="o">.</span><span class="n">at</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">e_mean</span><span class="p">)</span>
<div class="viewcode-block" id="GradientRQ.y_flat">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.GradientRQ.y_flat">[docs]</a>
</span><span data-line="844">        <span class="bp">self</span><span class="o">.</span><span class="n">y_flat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_full</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span></div>

</span><span data-line="845">        <span class="n">D_plus_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
</span><span data-line="846">
</span><span data-line="847">        <span class="c1"># Initial Guesses (Seed the optimizer in the physical basin)</span>
</span><span data-line="848">        <span class="n">init_ls</span> <span class="o">=</span> <span class="n">length_scale</span> <span class="k">if</span> <span class="n">length_scale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mf">1.5</span>
</span><span data-line="849">        <span class="n">init_alpha</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span data-line="850">        <span class="n">init_noise</span> <span class="o">=</span> <span class="mf">1e-2</span>
</span><span data-line="851">
</span><span data-line="852">        <span class="k">if</span> <span class="n">optimize</span><span class="p">:</span>
</span><span data-line="853">            <span class="n">x0</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">init_ls</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">init_alpha</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">init_noise</span><span class="p">)])</span>
</span><span data-line="854">
</span><span data-line="855">            <span class="k">def</span><span class="w"> </span><span class="nf">loss_fn</span><span class="p">(</span><span class="n">log_p</span><span class="p">):</span>
</span><span data-line="856">                <span class="c1"># Use the MAP loss (with priors)</span>
</span><span data-line="857">                <span class="k">return</span> <span class="n">negative_mll_rq_map</span><span class="p">(</span><span class="n">log_p</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_flat</span><span class="p">,</span> <span class="n">D_plus_1</span><span class="p">)</span>
</span><span data-line="858">
</span><span data-line="859">            <span class="c1"># BFGS with Stiff Priors</span>
</span><span data-line="860">            <span class="n">results</span> <span class="o">=</span> <span class="n">jopt</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">loss_fn</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;BFGS&quot;</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
</span><span data-line="861">
</span><span data-line="862">            <span class="bp">self</span><span class="o">.</span><span class="n">ls</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span data-line="863">            <span class="bp">self</span><span class="o">.</span><span class="n">alpha_param</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</span><span data-line="864">            <span class="bp">self</span><span class="o">.</span><span class="n">noise</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
</span><span data-line="865">
</span><span data-line="866">            <span class="c1"># Fallback if optimization diverges</span>
</span><span data-line="867">            <span class="k">if</span> <span class="n">jnp</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ls</span><span class="p">)</span> <span class="ow">or</span> <span class="n">jnp</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="p">):</span>
</span><span data-line="868">                <span class="bp">self</span><span class="o">.</span><span class="n">ls</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha_param</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span> <span class="o">=</span> <span class="n">init_ls</span><span class="p">,</span> <span class="n">init_alpha</span><span class="p">,</span> <span class="n">init_noise</span>
</span><span data-line="869">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="870">            <span class="bp">self</span><span class="o">.</span><span class="n">ls</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha_param</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span> <span class="o">=</span> <span class="n">init_ls</span><span class="p">,</span> <span class="n">init_alpha</span><span class="p">,</span> <span class="n">init_noise</span>
</span><span data-line="871">
<div class="viewcode-block" id="GradientRQ.params">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.GradientRQ.params">[docs]</a>
</span><span data-line="872">        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">ls</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha_param</span><span class="p">])</span></div>

<div class="viewcode-block" id="GradientRQ.alpha">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.GradientRQ.alpha">[docs]</a>
</span><span data-line="873">        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">_grad_rq_solve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_full</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span></div>

</span><span data-line="874">
<div class="viewcode-block" id="GradientRQ.__call__">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.GradientRQ.__call__">[docs]</a>
</span><span data-line="875">    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_query</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
</span><span data-line="876">        <span class="n">x_query</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x_query</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span data-line="877">        <span class="n">preds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="878">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x_query</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">chunk_size</span><span class="p">):</span>
</span><span data-line="879">            <span class="n">chunk</span> <span class="o">=</span> <span class="n">x_query</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">chunk_size</span><span class="p">]</span>
</span><span data-line="880">            <span class="n">preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_grad_rq_predict</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">))</span>
</span><span data-line="881">        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_mean</span></div>
</div>

</span><span data-line="882">
</span><span data-line="883">
</span><span data-line="884"><span class="c1"># Factory for string-based instantiation</span>
<div class="viewcode-block" id="get_surface_model">
<a class="viewcode-back" href="../../autoapi/rgpycrumbs/surfaces/index.html#rgpycrumbs.surfaces.get_surface_model">[docs]</a>
</span><span data-line="885"><span class="k">def</span><span class="w"> </span><span class="nf">get_surface_model</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
</span><span data-line="886">    <span class="n">models</span> <span class="o">=</span> <span class="p">{</span>
</span><span data-line="887">        <span class="s2">&quot;grad_matern&quot;</span><span class="p">:</span> <span class="n">GradientMatern</span><span class="p">,</span>
</span><span data-line="888">        <span class="s2">&quot;grad_rq&quot;</span><span class="p">:</span> <span class="n">GradientRQ</span><span class="p">,</span>
</span><span data-line="889">        <span class="s2">&quot;grad_se&quot;</span><span class="p">:</span> <span class="n">GradientSE</span><span class="p">,</span>
</span><span data-line="890">        <span class="s2">&quot;grad_imq&quot;</span><span class="p">:</span> <span class="n">GradientIMQ</span><span class="p">,</span>
</span><span data-line="891">        <span class="s2">&quot;matern&quot;</span><span class="p">:</span> <span class="n">FastMatern</span><span class="p">,</span>
</span><span data-line="892">        <span class="s2">&quot;imq&quot;</span><span class="p">:</span> <span class="n">FastIMQ</span><span class="p">,</span>
</span><span data-line="893">        <span class="s2">&quot;tps&quot;</span><span class="p">:</span> <span class="n">FastTPS</span><span class="p">,</span>
</span><span data-line="894">        <span class="s2">&quot;rbf&quot;</span><span class="p">:</span> <span class="n">FastTPS</span><span class="p">,</span>
</span><span data-line="895">    <span class="p">}</span>
</span><span data-line="896">    <span class="k">return</span> <span class="n">models</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">GradientMatern</span><span class="p">)</span></div>

</span></pre></div>
        </article><button class="back-to-top" type="button">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
  </svg>
  <span>Back to top</span>
</button><div class="navigation flex print:hidden"></div></div>
    </div>
  </main>
</div>
<footer class="sy-foot">
  <div class="sy-foot-inner sy-container mx-auto">
    
    <div
      style="
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
        color: var(--sy-c-text-weak);
        font-size: 0.9em;
      "
    >
      <div
        style="
          display: flex;
          flex-wrap: wrap;
          justify-content: center;
          gap: 1rem;
          align-items: center;
        "
      >
        
        <span style="display: inline-flex; align-items: center; gap: 0.3em">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="1em"
            height="1em"
            viewBox="0 0 24 24"
            fill="currentColor"
            aria-hidden="true"
          >
            <path d="M7,20H4V4h3V20z M14,20h-3V12h3V20z M21,20h-3V8h3V20z" />
          </svg>
          <span
            >Analytics by
            <a
              href="https://plausible.io/"
              target="_blank"
              rel="noopener noreferrer"
              style="color: inherit; text-decoration: underline"
              >Plausible</a
            ></span
          >
        </span>

        
        <span style="display: inline-flex; align-items: center; gap: 0.3em">
          <span>provided by</span>
          <span style="display: inline-flex; align-items: center; gap: 0.3em">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="1.2em"
              height="1.2em"
              viewBox="0 0 64 64"
              aria-hidden="true"
            >
              <g fill-rule="evenodd">
                <ellipse cx="32" cy="11" fill="#80D25B" rx="7" ry="9" />
                <path
                  fill="#80D25B"
                  d="M20.302104,46 C20.302104,46 17.1330329,55.8812548 20.6828149,59.7817355 C24.232597,63.6822162 26.8008673,63.215359 26.8008673,53.7414927 C26.8008673,44.2676263 20.302104,46 20.302104,46 Z"
                />
                <path
                  fill="#80D25B"
                  d="M38.302104,46 C38.302104,46 35.1330329,55.8812548 38.6828149,59.7817355 C42.232597,63.6822162 44.8008673,63.215359 44.8008673,53.7414927 C44.8008673,44.2676263 38.302104,46 38.302104,46 Z"
                  transform="matrix(-1 0 0 1 81.8 0)"
                />
                <path
                  fill="#80D25B"
                  d="M20.6227767,21.2218684 C20.6227767,21.2218684 13.956214,15.3844007 10.091955,16.0534044 C6.22769598,16.722408 6,22.2124633 6,23.9992899 C6,25.7861165 7.78917398,37.3159836 9.78726488,36.4967476 C11.7853558,35.6775115 13.7411938,27.959322 13.7411938,27.959322 15.6510232,30.2287702 18.609193,30.4630388"
                />
                <path
                  fill="#80D25B"
                  d="M57.6227767,21.2218684 C57.6227767,21.2218684 50.956214,15.3844007 47.091955,16.0534044 C43.227696,16.722408 43,22.2124633 43,23.9992899 C43,25.7861165 44.789174,37.3159836 46.7872649,36.4967476 C48.7853558,35.6775115 50.7411938,27.959322 50.7411938,27.959322 52.6510232,30.2287702 55.609193,30.4630388"
                  transform="matrix(-1 0 0 1 100.623 0)"
                />
                <path
                  fill="#BD7575"
                  stroke="#595959"
                  stroke-linecap="round"
                  stroke-width="2"
                  d="M32,53 C40.836556,53 48,44.4934102 48,34 C48,23.5065898 46.6814044,17 32,17 C17.3185956,17 16,23.5065898 16,34 C16,44.4934102 23.163444,53 32,53 Z"
                />
                <polygon
                  fill="#BD7575"
                  stroke="#595959"
                  stroke-linecap="round"
                  stroke-width="2"
                  points="32 22 38.928 26 38.928 34 32 38 25.072 34 25.072 26"
                />
                <path
                  stroke="#595959"
                  stroke-linecap="round"
                  stroke-width="2"
                  d="M30,8 C28.8954305,8 28,8.8954305 28,10"
                />
                <path
                  stroke="#595959"
                  stroke-linecap="round"
                  stroke-width="2"
                  d="M36,8 C34.8954305,8 34,8.8954305 34,10"
                  transform="matrix(-1 0 0 1 70 0)"
                />
                <path
                  stroke="#595959"
                  stroke-linecap="round"
                  stroke-width="2"
                  d="M32.1194396 38.1881507L32.1194396 52.4125899M32.0164956 21.7467197L32.0164956 17M25.2141026 26.0041506L17.737148 23.0721126M25.1254173 34.1534318L16.7659494 38.8876521"
                />
                <path
                  stroke="#595959"
                  stroke-linecap="round"
                  stroke-width="2"
                  d="M46.2141026,26.0041506 L38.737148,23.0721126"
                  transform="matrix(-1 0 0 1 84.951 0)"
                />
                <path
                  stroke="#595959"
                  stroke-linecap="round"
                  stroke-width="2"
                  d="M47.1254173,34.1534318 L38.7659494,38.8876521"
                  transform="matrix(-1 0 0 1 85.891 0)"
                />
              </g>
            </svg>
            <a
              href="https://turtletech.us/"
              target="_blank"
              rel="noopener noreferrer"
              style="color: inherit; text-decoration: underline"
              >TurtleTech ehf</a
            >
          </span>
        </span>
      </div>
    </div>

    
    <div class="sy-foot-reserved md:flex justify-between items-center">
      <div class="sy-foot-copyright"><p>2025, Rohit Goswami</p>
  
  <p>
    Made with
    
    <a href="https://www.sphinx-doc.org/">Sphinx</a> and
    
    <a href="https://shibuya.lepture.com">Shibuya theme</a>.
  </p>
</div> <div class="sy-foot-socials">
<a href="https://github.com/Haozeke/rgpycrumbs" aria-label="GitHub">
  <iconify-icon icon="simple-icons:github"></iconify-icon>
</a></div>
    </div>
  </div>
</footer>
      <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../_static/doctools.js?v=fd6eb6e6"></script>
      <script src="../../_static/sphinx_highlight.js?v=6ffebe34"></script>
      <script src="../../_static/shibuya.js?v=cac61aee"></script></body>
</html>