#+TITLE: ~rgpycrumbs~ Design & Architecture Notes
#+OPTIONS: toc:nil todo:nil num:nil author:t title:t
#+STARTUP: overview

* Documentation Pipeline
  :PROPERTIES:
  :ID:       docs-architecture
  :END:

We craft documents in ~orgmode~, though downstream processing uses ~sphinx~.
Partially because of this, since ~ox-rst~ needs ~emacs~, and because the
documentation rarely needs to be built outside of the development workflow,
instead of staying within the ~pyproject~ file as an optional dependency the
documentation forms a new environment in the ~pixi.toml~ file.
* Dependency management
- Library :: go in ~pyproject.toml~.
- Doc/Dev :: go in ~pixi.toml~.
- Script :: handled on-the-fly via the ~uv~ dispatching mechanism and [[https://peps.python.org/pep-0723/][PEP 723]] detailed in my [[https://realpython.com/python-script-structure/][RealPython best practices post]].
* Core Architecture: The Dispatcher
  :PROPERTIES:
  :ID:       cli-dispatch
  :END:

** The Problem
Research pipelines require conflicting environments and a monolithic CLI
(e.g., standard ~Typer~ app) fails because importing the top-level module
crashes due to conflicting dependencies in sub-modules.

** The Solution: Dynamic Subprocess Dispatch
   Instead of directly importing modules, ~rgpycrumbs/cli.py~ controls execution flow:
   - It scans directory structure at runtime.
   - It invokes scripts via ~uv run~.
   - This leads to complete isolation for each script.

   #+BEGIN_SRC python
   # Logic captured in rgpycrumbs/cli.py
   subprocess.run(["uv", "run", script_path] + args)
   #+END_SRC

** Philosophy

The library is designed with the following principles in mind:

- Dispatcher-Based Architecture :: The top-level ~rgpycrumbs.cli~ command acts as a
  lightweight dispatcher. It does not contain the core logic of the tools
  itself. Instead, it parses user commands to identify the target script and
  then invokes it in an isolated subprocess using the ~uv~ runner. This provides
  a unified command-line interface while keeping the tools decoupled.

- Isolated & Reproducible Execution :: Each script is a self-contained unit that
  declares its own dependencies via [[https://peps.python.org/pep-0723/][PEP 723]] metadata. The ~uv~ runner uses this
  information to resolve and install the exact required packages into a
  temporary, cached environment on-demand. This design guarantees
  reproducibility and completely eliminates the risk of dependency conflicts
  between different tools in the collection.

- Lightweight Core, On-Demand Dependencies :: The installable ~rgpycrumbs~
  package has minimal core dependencies (~click~, ~numpy~). Heavy scientific
  libraries are available as optional extras (e.g. ~pip install
  rgpycrumbs[surfaces]~ for JAX). For CLI tools, dependencies are fetched by
  ~uv~ only when a script that needs them is executed, keeping the base
  installation lightweight.

- Modular & Extensible Tooling :: Each utility is an independent script. This
  modularity simplifies development, testing, and maintenance, as changes to one
  tool cannot inadvertently affect another. New tools can be added to the
  collection without modifying the core dispatcher logic, making the system
  easily extensible.

* Library Modules
  :PROPERTIES:
  :ID:       library-modules
  :END:

In addition to the CLI dispatcher, ~rgpycrumbs~ provides importable library
modules for computational tasks. These are used by downstream packages like
~chemparseplot~ and can be used directly in notebooks or custom scripts.

** Module Structure

- ~rgpycrumbs.surfaces~ :: JAX-based surface fitting with kernel methods (TPS,
  RBF, Matern 5/2, SE, IMQ). Includes gradient-enhanced variants. Optional
  dependency: ~jax~.
- ~rgpycrumbs.geom.analysis~ :: Structure analysis using ASE: distance matrices,
  bond matrices, and fragment detection via depth-first search on neighbor
  lists. Optional dependencies: ~ase~, ~scipy~.
- ~rgpycrumbs.geom.ira~ :: Iterative Rotations and Assignments (IRA) for
  RMSD-based structure comparison. Optional dependency: ~ira_mod~.
- ~rgpycrumbs.interpolation~ :: Spline interpolation utilities built on SciPy.
  Optional dependency: ~scipy~.
- ~rgpycrumbs.basetypes~ :: Shared data structures (namedtuples and dataclasses)
  for NEB iterations, NEB paths, saddle search measurements, dimer
  optimization, molecular geometries, and spin identification. No extra
  dependencies.

** Lazy Loading
The top-level ~rgpycrumbs/__init__.py~ uses ~__getattr__~ for lazy imports, so
modules with heavy optional dependencies (like JAX) are only loaded when
accessed. This keeps ~import rgpycrumbs~ fast regardless of which extras are
installed.
